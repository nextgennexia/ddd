function getOffers(){$.ajax({type:"GET",url:"offers.json",success:function(a){$.each(a,function(){offers.push(this)}),renderShortOffers()}})}function offerRefresh(){$.ajax({async:!1,type:"POST",data:JSON.stringify(offers),url:"/refresh",contentType:"application/json",success:function(a){try{offers=JSON.parse(a).slice()}catch(b){offerRefresh()}}})}function getUser(a){$.ajax({type:"GET",url:"users.json",success:function(b){$.each(b,function(){this.id==a&&(user=this)}),renderShortOffers(),renderLoggedUser()}})}function offerActionHandler(a){var b=$(a.target),c=b.attr("data-button"),d=new Offer(this);switch(c){case"like":d.like();break;case"save":d.save();break;case"viewComment":d.viewComment(b);break;case"openOfferLightbox":d.openofferLightbox();break;case"removeComment":d.removeComment(b.parents(".author"));break;case"removeAnswer":d.removeAnswer(b.parents(".author"));break;case"removeOffer":d.removeOffer()}}function commentingHandler(a){13==a.charCode&&($(this).parents(".offer-plate").length&&new Offer($(this).parents(".offer-plate")).addComment(this.value),$(this).parents(".lightbox.offer").length&&new Offer($(this).parents(".lightbox.offer")).addAnswer(this.value))}function Offer(a){var b=$(a),c=b.attr("data-id"),d=!1;this.like=function(){$.each(offers[c].likes[0].fromUsers,function(a){return this.userId==user.id?(d=!0,offers[c].likes[0].count-=1,offers[c].likes[0].fromUsers.splice(a,1),offerRefresh(),renderShortOffers(),renderOffer(c),!1):void 0}),d||(offers[c].likes[0].count+=1,obj={userId:user.id,avatar:user.avatar},offers[c].likes[0].fromUsers.push(obj),offerRefresh(),renderShortOffers(),renderOffer(c))},this.save=function(){$.each(offers[c].saved[0].fromUsers,function(a){return this.userId==user.id?(d=!0,offers[c].saved[0].count-=1,offers[c].saved[0].fromUsers.splice(a,1),offerRefresh(),renderShortOffers(),renderOffer(c),!1):void 0}),d||(offers[c].saved[0].count+=1,obj={userId:user.id,avatar:user.avatar},offers[c].saved[0].fromUsers.push(obj),offerRefresh(),renderShortOffers(),renderOffer(c))},this.viewComment=function(a){b.find(".latest-comments").toggleClass("hidden"),b.find(".add-comment").toggleClass("hidden"),b.find(".add-answer").toggleClass("hidden"),a.toggleClass("active")},this.openofferLightbox=function(){$(".lightbox-wrap").toggleClass("hidden"),renderOffer(c)},this.addComment=function(a){var b;b=offers[c].comments[0].count?offers[c].comments[0].fromUsers[offers[c].comments[0].fromUsers.length-1].id+1:0,obj={id:b,userId:user.id,avatar:user.avatar,comment:a},offers[c].comments[0].count+=1,offers[c].comments[0].fromUsers.push(obj),offerRefresh(),renderShortOffers()},this.addAnswer=function(a){var b;b=offers[c].answers[0].fromUsers.length?offers[c].answers[0].fromUsers[offers[c].answers[0].fromUsers.length-1].id+1:0,obj={id:b,userId:user.id,avatar:user.avatar,comment:a},offers[c].answers[0].count+=1,offers[c].answers[0].fromUsers.push(obj),offerRefresh(),renderShortOffers(),renderOffer(c)},this.removeComment=function(a){for(var b=offers[c].comments[0].fromUsers,d=a.attr("data-id"),e=[],f=0;f<b.length;f++)b[f].id==d&&(e.push(b[f]),offers[c].comments[0].count-=1,b.splice(f,1));a.remove(),offerRefresh()},this.removeAnswer=function(a){var b=offers[c].answers[0].fromUsers,d=a.attr("data-id");removedAnswer=[];for(var e=0;e<b.length;e++)b[e].id==d&&(removedAnswer.push(b[e]),offers[c].answers[0].count-=1,b.splice(e,1));a.remove(),offerRefresh()},this.removeOffer=function(){for(var a=[],b=0;b<offers.length;b++)offers[b].id==c&&(a.push(offers[b]),offers.splice(b,1));$(".lightbox-wrap").toggleClass("hidden"),$('.offer-plate[data-id="'+c+'"]').remove(),offerRefresh()}}function renderOffer(a){var b,c;b=$("#offer-templ").html(),c=Handlebars.compile(b);for(var d=0;d<offers.length;d++)offers[d].id==a&&$(".lightbox-wrap").html(c(offers[d]));renderAddMessage("answer"),$(".js-close-lightbox").on("click",function(){$(".lightbox-wrap").toggleClass("hidden")}),$(".lightbox.offer").on("click",offerActionHandler),$(".js-comment").on("keypress",commentingHandler)}function renderShortOffers(){var a,b,c=$(".column"),d=0;for(a=$("#offer-plate-templ").html(),b=Handlebars.compile(a),$.each(c,function(a){$(this).html("")});d<offers.length;)$.each(c,function(a){return $(this).append(b(offers[d])),d+=1,d>=offers.length?!1:void 0});renderAddMessage("comment"),$(".offer-plate").on("click",offerActionHandler),$(".js-comment").on("keypress",commentingHandler)}function renderAddMessage(a){var b,c,d,e;switch(a){case"comment":d="#add-comment-templ",e=".add-comment";break;case"answer":d="#add-answer-templ",e=".add-answer";break;default:return!1}b=$(d).html(),c=Handlebars.compile(b),$(e).append(c(user))}function renderLoggedUser(){var a,b;a=$("#user-plate-templ").html(),b=Handlebars.compile(a),$(".login-wrap .author").html(b(user))}var offers=[],user={fullname:"гость",avatar:"../../../images/lampa.gif"};$(".login .button").on("click",function(){var a=$(".login .field-text").val();a&&getUser(a)}),getOffers(),Handlebars.registerHelper("latestComments",function(a,b){var c,d,e="";if(a.length<5)for(c=0;c<a.length;c++)d=a[c].comment,a[c].comment.length>40&&(a[c].comment=a[c].comment.slice(0,40)+"..."),e+=b.fn(a[c]),a[c].comment=d;else for(c=a.length-5;c<a.length;c++)d=a[c].comment,a[c].comment.length>40&&(a[c].comment=a[c].comment.slice(0,40)+"..."),e+=b.fn(a[c]),a[c].comment=d;return e}),Handlebars.registerHelper("latestAnswers",function(a,b){var c,d="";if(a.length<3)for(c=0;c<a.length;c++)d+=b.fn(a[c]);else for(c=a.length-3;c<a.length;c++)d+=b.fn(a[c]);return d}),Handlebars.registerHelper("close",function(a,b){var c;return a&&a==user.id&&(c=b.fn(a)),c}),Handlebars.registerHelper("like",function(a,b){var c,d;for(d=0;d<a.length;d++)a[d].userId==user.id&&(a.liked="active");return c=b.fn(a),delete a.liked,c}),Handlebars.registerHelper("removeOffer",function(a,b){var c,d;for(d=0;d<a.length;d++)a[d].userId!=user.id&&(a.hidden="hidden");return c=b.fn(a),delete a.hidden,c}),Handlebars.registerHelper("save",function(a,b){var c,d;for(d=0;d<a.length;d++)a[d].userId==user.id&&(a.saved="active");return c=b.fn(a),delete a.saved,c}),Handlebars.registerHelper("hasCount",function(a,b){var c;return 0!=a&&(c=b.fn(a)),c});