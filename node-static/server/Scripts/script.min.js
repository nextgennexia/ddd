function getOffers(){$.ajax({type:"GET",url:"offers.json",success:function(a){$.each(a,function(){offers.push(this)}),createOffersPlate(offers)}})}function offerRefresh(){$.ajax({async:!1,type:"POST",data:JSON.stringify(offers),url:"/refresh",contentType:"application/json",success:function(a){offers.splice(0,offers.length),$.each(JSON.parse(a),function(){offers.push(this)})}})}function createOffer(a){var b,c;b=$("#offer-templ").html(),c=Handlebars.compile(b),$(".js-lightbox-offer").html(c(offers[a])),$(".close-lightbox").on("click",function(){$(".js-lightbox-offer").toggleClass("hidden")}),$(".lightbox-offer").on("click",socialActionHandler),$(".js-comment").on("keypress",addAnswer)}function createOffersPlate(){var a,b;a=$("#offer-plate-templ").html(),b=Handlebars.compile(a);var c=$(".column"),d=[],e=0;for(jQuery.each(c,function(a){$(this).html("")});e<offers.length;)jQuery.each(c,function(a){return e>=offers.length?!1:(d[a]=$(this).find(".offer-plate").length,$(this).append(b(offers[e])),void(e+=1))});$(".offer-plate").on("click",socialActionHandler),$(".js-comment").on("keypress",addComment)}function getUser(a){$.ajax({type:"GET",url:"users.json",success:function(b){$.each(b,function(){this.id==a&&(user=this)}),createOffersPlate(offers)}})}function socialActionHandler(a){var b=$(a.target),c=$(this),d=c.attr("data-id")-1,e=!1;b.hasClass("js-like")&&($.each(offers[d].likes[0].fromUsers,function(a){return this.userId==user.id?(e=!0,offers[d].likes[0].count-=1,offers[d].likes[0].fromUsers.splice(a,1),offerRefresh(),createOffersPlate(offers),createOffer(d),!1):void 0}),e||(offers[d].likes[0].count+=1,obj={userId:user.id,avatar:user.avatar},offers[d].likes[0].fromUsers.push(obj),offerRefresh(),createOffersPlate(offers),createOffer(d))),b.hasClass("js-offer-save")&&($.each(offers[d].saved[0].fromUsers,function(a){return this.userId==user.id?(e=!0,offers[d].saved[0].count-=1,offers[d].saved[0].fromUsers.splice(a,1),offerRefresh(),createOffersPlate(offers),createOffer(d),!1):void 0}),e||(offers[d].saved[0].count+=1,obj={userId:user.id,avatar:user.avatar},offers[d].saved[0].fromUsers.push(obj),offerRefresh(),createOffersPlate(offers),createOffer(d))),b.hasClass("js-comments")&&(c.find(".latest-comments").toggleClass("hidden"),c.find(".add-comment").toggleClass("hidden")),b.hasClass("js-answer")&&($(".js-lightbox-offer").toggleClass("hidden"),createOffer(d)),b.hasClass("view-offer")&&($(".js-lightbox-offer").toggleClass("hidden"),createOffer(d))}function addComment(a){if(13==a.charCode){var b=$(this).parents(".offer-plate"),c=b.attr("data-id")-1;obj={userId:user.id,avatar:user.avatar,comment:this.value},offers[c].comments[0].count+=1,offers[c].comments[0].fromUsers.push(obj),offerRefresh(),createOffersPlate(offers)}}function addAnswer(a){if(13==a.charCode){var b=$(this).parents(".lightbox-offer"),c=b.attr("data-id")-1;obj={userId:user.id,avatar:user.avatar,comment:this.value},offers[c].answers[0].count+=1,offers[c].answers[0].fromUsers.push(obj),offerRefresh(),createOffersPlate(offers),createOffer(c)}}var offers=[];getOffers(),Handlebars.registerHelper("latestComments",function(a,b){var c="";if(a.length<3)for(var d=0;d<a.length;d++)c+=b.fn(a[d]);else for(var d=a.length-3;d<a.length;d++)c+=b.fn(a[d]);return c});var user=[];$(".login .button").on("click",function(){var a=$(".login .field-text").val();a&&getUser(a)});