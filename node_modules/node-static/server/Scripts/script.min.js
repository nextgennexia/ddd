function getLoggedUser(a){$.post("/get-user",a,function(a){$.each(preparedObj.offers,function(){this.user=a}),renderUser(preparedObj.userTempl),renderOffersCards(preparedObj.offerCardTempl)},"json","text/plain")}function renderOffersCards(a){var b,c=$(".column"),d=$.handlers(),e=0;for($.each(c,function(){$(this).html("")});e<preparedObj.offers.length;)for(b=0;b<c.length;b++)if(preparedObj.offers[e].removed)e++,b--;else if($(c[b]).append(a(preparedObj.offers[e])),e++,e>=preparedObj.offers.length)break;$(".js-offer-card-wrap").on("click",d.offerActionHandler),$(".js-comment").on("keypress",d.commentingHandler)}function renderOfferCard(a,b){var c=$.handlers();$('.js-offer-card-wrap[data-id="'+b+'"]').replaceWith(a(preparedObj.offers[b])),$('.js-offer-card-wrap[data-id="'+b+'"]').on("click",c.offerActionHandler),$('.js-offer-card-wrap[data-id="'+b+'"] .js-comment').on("keypress",c.commentingHandler)}function renderOffer(a,b){var c=$.handlers();$(".lightbox-wrap").html(a(preparedObj.offers[b])),$(".lightbox.offer").on("click",c.offerActionHandler),$(".js-answer").on("keypress",c.commentingHandler)}function renderUser(a){var b=$.handlers();$(".login-wrap").html(a(preparedObj.offers[0].user)),$(".login .button").on("click",b.loginHandler)}Array.prototype.last=function(){return this[this.length-1]},function(a){a.offerCard=function(b){var c={params:a.extend(b),like:function(){c.countActions("likes")},save:function(){c.countActions("saved")},viewComments:function(a){preparedObj.offers[b.offerId].states[a]=!preparedObj.offers[b.offerId].states[a],b.offerNode.find(".comments").toggleClass("hidden"),b.targetNode.toggleClass("active")},toogleOfferLightbox:function(){a("body").toggleClass("lock"),a(".lightbox-wrap").toggleClass("hidden")},addMessage:function(a,c){var d;d=preparedObj.offers[b.offerId][a][0].count?preparedObj.offers[b.offerId][a][0].fromUsers.last().id+1:0,obj={id:d,userId:preparedObj.offers[b.offerId].user.id,avatar:preparedObj.offers[b.offerId].user.avatar,comment:c},preparedObj.offers[b.offerId][a][0].count+=1,preparedObj.offers[b.offerId][a][0].fromUsers.push(obj)},removeMessage:function(c){a.each(preparedObj.offers[b.offerId][c][0].fromUsers,function(){return this.id==b.targetNode.parents(".author").attr("data-id")?(preparedObj.offers[b.offerId][c][0].count-=1,this.removed=!0,!1):void 0})},removeOffer:function(){preparedObj.offers[b.offerId].removed=!0},countActions:function(c){var d=!1;a.each(preparedObj.offers[b.offerId][c][0].fromUsers,function(a){return this.userId==preparedObj.offers[b.offerId].user.id?(d=!0,preparedObj.offers[b.offerId][c][0].count-=1,preparedObj.offers[b.offerId][c][0].fromUsers.splice(a,1),!1):void 0}),d||(preparedObj.offers[b.offerId][c][0].count+=1,obj={userId:preparedObj.offers[b.offerId].user.id,avatar:preparedObj.offers[b.offerId].user.avatar},preparedObj.offers[b.offerId][c][0].fromUsers.push(obj))},sendData:function(){a.ajax({method:"POST",url:"/refresh",data:JSON.stringify(preparedObj.offers),dataType:"json",success:function(a){try{preparedObj.offers=a.slice()}catch(b){sendData()}}})}};return{like:c.like,save:c.save,viewComments:c.viewComments,toogleOfferLightbox:c.toogleOfferLightbox,addMessage:c.addMessage,removeMessage:c.removeMessage,removeOffer:c.removeOffer,sendData:c.sendData}}}(jQuery);var preparedObj=[];!function(){preparedObj.offerCardTempl=Handlebars.compile($("#offer-card-templ").html()),preparedObj.offerTempl=Handlebars.compile($("#offer-templ").html()),preparedObj.userTempl=Handlebars.compile($("#user-plate-templ").html()),$.get("/offers.json",function(a){preparedObj.offers=a.slice(),$.each(preparedObj.offers,function(){this.states={hiddenComments:!0,hiddenAnswers:!0},this.user={fullname:"Гость",avatar:"../../../images/users/anonymous.png"}}),renderUser(preparedObj.userTempl),renderOffersCards(preparedObj.offerCardTempl)},"json")}(),function(a){a.handlers=function(){var b={loginHandler:function(){getLoggedUser(a(".login .field-text").val())},offerActionHandler:function(b){var c=a(b.target),d=c.attr("data-button")||c.parents("[data-button]").attr("data-button"),e=a(this),f=e.attr("data-id"),g=a.offerCard({offerId:f,targetNode:c,offerNode:e});switch(d){case"like":g.like(),g.sendData(),e.hasClass("lightbox offer")&&renderOffer(preparedObj.offerTempl,f),renderOfferCard(preparedObj.offerCardTempl,f);break;case"save":g.save(),g.sendData(),e.hasClass("lightbox offer")&&renderOffer(preparedObj.offerTempl,f),renderOfferCard(preparedObj.offerCardTempl,f);break;case"viewComment":g.viewComments("hiddenComments");break;case"viewAnswer":g.viewComments("hiddenAnswers");break;case"openOfferLightbox":g.toogleOfferLightbox(),renderOffer(preparedObj.offerTempl,f);break;case"closeOfferLightbox":g.toogleOfferLightbox();break;case"removeComment":g.removeMessage("comments"),g.sendData(),renderOfferCard(preparedObj.offerCardTempl,f);break;case"removeAnswer":g.removeMessage("answers"),g.sendData(),renderOfferCard(preparedObj.offerCardTempl,f),renderOffer(preparedObj.offerTempl,f);break;case"removeOffer":g.removeOffer(),g.sendData(),g.toogleOfferLightbox(),renderOffersCards(preparedObj.offerCardTempl)}},commentingHandler:function(b){var c=a(this).attr("data-id"),d=a.offerCard({offerId:c});13!=b.keyCode&&13!=b.which||b.shiftKey||!this.value||(a(this).hasClass("js-comment")&&(d.addMessage("comments",this.value),d.sendData(),renderOfferCard(preparedObj.offerCardTempl,c)),a(this).hasClass("js-answer")&&(d.addMessage("answers",this.value),d.sendData(),renderOfferCard(preparedObj.offerCardTempl,c),renderOffer(preparedObj.offerTempl,c)),a(this).val(""),b.preventDefault())}};return{loginHandler:b.loginHandler,offerActionHandler:b.offerActionHandler,commentingHandler:b.commentingHandler}}}(jQuery),Handlebars.registerHelper("ifCond",function(a,b,c,d){switch(b){case"!=":return a!=c?d.fn(this):d.inverse(this);case"==":return a==c?d.fn(this):d.inverse(this);case"===":return a===c?d.fn(this):d.inverse(this);case"<":return c>a?d.fn(this):d.inverse(this);case"<=":return c>=a?d.fn(this):d.inverse(this);case">":return a>c?d.fn(this):d.inverse(this);case">=":return a>=c?d.fn(this):d.inverse(this);case"&&":return a&&c?d.fn(this):d.inverse(this);case"||":return a||c?d.fn(this):d.inverse(this);default:return d.inverse(this)}}),Handlebars.registerHelper("renderLatestMessages",function(a,b,c,d){var e,f="",g=0,h=a.length-1;for(g;b>g;g++)if(a[h]){if(a[h].removed){h--,g--;continue}e=a[h].comment,c&&a[h].comment.length>c&&(a[h].comment=a[h].comment.slice(0,c)+"..."),f=d.fn(a[h])+f,a[h].comment=e,h--}return f});