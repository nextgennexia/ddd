var login=function(){return{authorize:function(a,b){$.post("/get-user",a,function(a){$.each(preparedObj.offers,function(){this.user=a}),login.renderUser(),b&&b()},"json","text/plain")},renderUser:function(){$(".login-wrap .author").html(preparedObj.userTempl(preparedObj.offers[0].user))}}}(),preparedObj=[];Array.prototype.last=function(){return this[this.length-1]},function(){preparedObj.offerCardTempl=Handlebars.compile($("#offer-card-templ").html()),preparedObj.offerTempl=Handlebars.compile($("#offer-templ").html()),preparedObj.userTempl=Handlebars.compile($("#user-plate-templ").html()),$.get("/offers.json",function(a){preparedObj.offers=a.slice(),$.each(preparedObj.offers,function(){this.states={hiddenComments:!0,hiddenAnswers:!0,hiddenOfferLightbox:!0},this.user={fullname:"Гость",avatar:"../../../images/users/anonymous.png"}}),$(".js-auth").on("click",handling.loginHandler),$(".lightboxes").on({click:handling.offerActionHandler,keypress:handling.commentingHandler}),login.renderUser(),offerCard.renderOffersCards()},"json")}();var handling=function(){return{loginHandler:function(){login.authorize($(".js-login").val(),function(){offerCard.renderOffersCards()})},offerActionHandler:function(a){var b=$(this),c=$(a.target),d=c.attr("data-button")||c.parents("[data-button]").attr("data-button"),e=c.parents(".author").attr("data-id"),f=b.attr("data-id")||b.children().first().attr("data-id");switch(d){case"like":offerCard.like(f),offerCard.sendData(),offerCard.renderOfferCard(f);break;case"like-lbx":offerCard.like(f),offerCard.sendData(),offerCard.renderOfferCard(f),offerCard.renderOfferLightbox(f);break;case"save":offerCard.save(f),offerCard.sendData(),offerCard.renderOfferCard(f);break;case"save-lbx":offerCard.save(f),offerCard.sendData(),offerCard.renderOfferCard(f),offerCard.renderOfferLightbox(f);break;case"viewComment":offerCard.viewComments(f),offerCard.renderOfferCard(f);break;case"viewAnswer":offerCard.viewAnswers(f),offerCard.renderOfferLightbox(f);break;case"openOfferLightbox":offerCard.openOfferLightbox(f);break;case"closeOfferLightbox":offerCard.closeOfferLightbox(f);break;case"removeComment":offerCard.removeComment(f,e),offerCard.sendData(),offerCard.renderOfferCard(f);break;case"removeAnswer":offerCard.removeAnswer(f,e),offerCard.sendData(),offerCard.renderOfferCard(f),offerCard.renderOfferLightbox(f);break;case"removeOffer":offerCard.removeOffer(f),offerCard.sendData(),offerCard.closeOfferLightbox(f),offerCard.renderOffersCards()}},commentingHandler:function(a){var b=$(a.target),c=b.attr("data-id");13!=a.keyCode&&13!=a.which||a.shiftKey||!b.val()||(b.hasClass("js-comment")&&(offerCard.addComment(c,b.val()),offerCard.sendData(),offerCard.renderOfferCard(c)),b.hasClass("js-answer")&&(offerCard.addAnswer(c,b.val()),offerCard.sendData(),offerCard.renderOfferCard(c),offerCard.renderOfferLightbox(c)),b.val(""),a.preventDefault())}}}();Handlebars.registerHelper("ifCond",function(a,b,c,d){switch(b){case"!=":return a!=c?d.fn(this):d.inverse(this);case"==":return a==c?d.fn(this):d.inverse(this);case"===":return a===c?d.fn(this):d.inverse(this);case"<":return c>a?d.fn(this):d.inverse(this);case"<=":return c>=a?d.fn(this):d.inverse(this);case">":return a>c?d.fn(this):d.inverse(this);case">=":return a>=c?d.fn(this):d.inverse(this);case"&&":return a&&c?d.fn(this):d.inverse(this);case"||":return a||c?d.fn(this):d.inverse(this);default:return d.inverse(this)}}),Handlebars.registerHelper("renderLatestMessages",function(a,b,c){return c.fn($.grep(a,function(a,b){return!a.removed}).slice(-b))}),Handlebars.registerHelper("trancate",function(a,b,c){return a.length>b?c.fn(a.slice(0,b)+"..."):c.fn(a)});var offerCard=function(){function a(a,b,c){preparedObj.offers[b][a].push({id:preparedObj.offers[b][a].length,userId:preparedObj.offers[b].user.id,avatar:preparedObj.offers[b].user.avatar,comment:c})}function b(a,b){var c=!1;$.each(preparedObj.offers[b][a],function(d){return this.userId==preparedObj.offers[b].user.id?(c=!0,preparedObj.offers[b][a].splice(d,1),!1):void 0}),c||preparedObj.offers[b][a].push({userId:preparedObj.offers[b].user.id,avatar:preparedObj.offers[b].user.avatar})}function c(a,b,c){c===!0?preparedObj.offers[b].states[a]=!1:c===!1?preparedObj.offers[b].states[a]=!0:preparedObj.offers[b].states[a]=!preparedObj.offers[b].states[a]}return{like:function(a){b("likes",a)},save:function(a){b("saved",a)},viewComments:function(a){c("hiddenComments",a)},viewAnswers:function(a){c("hiddenAnswers",a)},addComment:function(b,c){a("comments",b,c)},addAnswer:function(b,c){a("answers",b,c)},removeComment:function(a,b){preparedObj.offers[a].comments[b].removed=!0},removeAnswer:function(a,b){preparedObj.offers[a].answers[b].removed=!0},openOfferLightbox:function(a){c("hiddenOfferLightbox",a,!0),$("body").addClass("lock"),offerCard.renderOfferLightbox(a)},closeOfferLightbox:function(a){c("hiddenOfferLightbox",a,!1),$("body").removeClass("lock"),offerCard.renderOfferLightbox(a)},removeOffer:function(a){preparedObj.offers[a].removed=!0},sendData:function(){$.ajax({method:"POST",url:"/refresh",data:JSON.stringify(preparedObj.offers),dataType:"json",success:function(a){try{preparedObj.offers=a.slice()}catch(b){sendData()}}})},renderOffersCards:function(){var a=$(".column"),b=0;$.each(a,function(){$(this).html("")}),$.each(preparedObj.offers,function(c,d){d.removed||(b>3&&(b=0),$(a[b]).append(preparedObj.offerCardTempl(d)),b++)}),$(".js-offer-card-wrap").on({click:handling.offerActionHandler,keypress:handling.commentingHandler})},renderOfferCard:function(a){$('.js-offer-card-wrap[data-id="'+a+'"]').html(preparedObj.offerCardTempl(preparedObj.offers[a]))},renderOfferLightbox:function(a){$(".lightboxes").html(preparedObj.offerTempl(preparedObj.offers[a]))}}}();