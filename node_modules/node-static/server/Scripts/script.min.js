!function(a){a.login=function(b,c){var d={params:a.extend(b),authorize:function(){a.post("/get-user",b.id,function(b){a.each(preparedObj.offers,function(){this.user=b}),d.renderUser()},"json","text/plain")},renderUser:function(){b.loginNode.html(preparedObj.userTempl(preparedObj.offers[0].user)),c&&c()}};return{authorize:function(){d.authorize(),d.renderUser()},renderUser:function(){d.renderUser()}}}}(jQuery);var preparedObj=[];Array.prototype.last=function(){return this[this.length-1]},function(){preparedObj.offerCardTempl=Handlebars.compile($("#offer-card-templ").html()),preparedObj.offerTempl=Handlebars.compile($("#offer-templ").html()),preparedObj.userTempl=Handlebars.compile($("#user-plate-templ").html()),$.get("/offers.json",function(a){preparedObj.offers=a.slice(),$.each(preparedObj.offers,function(){this.states={hiddenComments:!0,hiddenAnswers:!0},this.user={fullname:"Гость",avatar:"../../../images/users/anonymous.png"}}),$.handlers().loginHandler()},"json")}(),function(a){a.handlers=function(){var b={loginHandler:function(){a.login({id:a(".login .field-text").val(),loginNode:a(".login-wrap .author")},function(){a(".login .button").on("click",b.loginHandler),a.offerCard().renderOffersCards(),a(".js-comment").on("keypress",b.commentingHandler)}).authorize()},offerActionHandler:function(b){var c=a(b.target),d=c.attr("data-button")||c.parents("[data-button]").attr("data-button"),e=a(this),f=e.attr("data-id"),g=a.offerCard({offerId:f,targetNode:c,offerNode:e,offerLightboxWrapNode:a(".lightbox-wrap")});switch(d){case"like":g.like();break;case"save":g.save();break;case"viewComment":g.viewComments();break;case"viewAnswer":g.viewAnswers();break;case"openOfferLightbox":g.openOfferLightbox();break;case"closeOfferLightbox":g.closeOfferLightbox();break;case"removeComment":g.removeComment();break;case"removeAnswer":g.removeAnswer();break;case"removeOffer":g.removeOffer()}},commentingHandler:function(b){var c=a.offerCard({offerId:a(this).attr("data-id"),offerNode:a(this).parents(".js-offer-card-wrap")});13!=b.keyCode&&13!=b.which||b.shiftKey||!this.value||(a(this).hasClass("js-comment")&&c.addComment(this.value),a(this).hasClass("js-answer")&&c.addMessage("answers",this.value),a(this).val(""),b.preventDefault())}};return{loginHandler:b.loginHandler,offerActionHandler:b.offerActionHandler,commentingHandler:b.commentingHandler}}}(jQuery),Handlebars.registerHelper("ifCond",function(a,b,c,d){switch(b){case"!=":return a!=c?d.fn(this):d.inverse(this);case"==":return a==c?d.fn(this):d.inverse(this);case"===":return a===c?d.fn(this):d.inverse(this);case"<":return c>a?d.fn(this):d.inverse(this);case"<=":return c>=a?d.fn(this):d.inverse(this);case">":return a>c?d.fn(this):d.inverse(this);case">=":return a>=c?d.fn(this):d.inverse(this);case"&&":return a&&c?d.fn(this):d.inverse(this);case"||":return a||c?d.fn(this):d.inverse(this);default:return d.inverse(this)}}),Handlebars.registerHelper("renderLatestMessages",function(a,b,c,d){var e,f="",g=0,h=a.length-1;for(g;b>g;g++)if(a[h]){if(a[h].removed){h--,g--;continue}e=a[h].comment,c&&a[h].comment.length>c&&(a[h].comment=a[h].comment.slice(0,c)+"..."),f=d.fn(a[h])+f,a[h].comment=e,h--}return f}),function(a){a.offerCard=function(b,c){var d={params:a.extend(b),like:function(){d.countActions("likes")},save:function(){d.countActions("saved")},viewMessages:function(a){preparedObj.offers[b.offerId].states[a]=!preparedObj.offers[b.offerId].states[a],b.offerNode.find(".comments").toggleClass("hidden"),b.targetNode.toggleClass("active")},toogleOfferLightbox:function(){a("body").toggleClass("lock"),b.offerLightboxWrapNode.toggleClass("hidden")},addMessage:function(a,c){var d;d=preparedObj.offers[b.offerId][a][0].count?preparedObj.offers[b.offerId][a][0].fromUsers.last().id+1:0,obj={id:d,userId:preparedObj.offers[b.offerId].user.id,avatar:preparedObj.offers[b.offerId].user.avatar,comment:c},preparedObj.offers[b.offerId][a][0].count+=1,preparedObj.offers[b.offerId][a][0].fromUsers.push(obj)},removeMessage:function(c){a.each(preparedObj.offers[b.offerId][c][0].fromUsers,function(){return this.id==b.targetNode.parents(".author").attr("data-id")?(preparedObj.offers[b.offerId][c][0].count-=1,this.removed=!0,!1):void 0})},removeOffer:function(){preparedObj.offers[b.offerId].removed=!0},countActions:function(c){var d=!1;a.each(preparedObj.offers[b.offerId][c][0].fromUsers,function(a){return this.userId==preparedObj.offers[b.offerId].user.id?(d=!0,preparedObj.offers[b.offerId][c][0].count-=1,preparedObj.offers[b.offerId][c][0].fromUsers.splice(a,1),!1):void 0}),d||(preparedObj.offers[b.offerId][c][0].count+=1,obj={userId:preparedObj.offers[b.offerId].user.id,avatar:preparedObj.offers[b.offerId].user.avatar},preparedObj.offers[b.offerId][c][0].fromUsers.push(obj))},sendData:function(){a.ajax({method:"POST",url:"/refresh",data:JSON.stringify(preparedObj.offers),dataType:"json",success:function(a){try{preparedObj.offers=a.slice()}catch(b){sendData()}}})},renderOffersCards:function(){var b,c,d=a(".column"),e=a.handlers(),f=0;for(a.each(d,function(){a(this).html("")});f<preparedObj.offers.length;)for(c=0;c<d.length;c++)if(preparedObj.offers[f].removed)f++,c--;else if(b=a(preparedObj.offerCardTempl(preparedObj.offers[f])),a(d[c]).append(b),b.on("click",e.offerActionHandler),f++,f>=preparedObj.offers.length)break},renderOfferCard:function(){var c=a.handlers(),d=a(preparedObj.offerCardTempl(preparedObj.offers[b.offerId]));b.offerNode.replaceWith(d),d.on("click",c.offerActionHandler),a('.js-offer-card-wrap[data-id="'+b.offerId+'"] .js-comment').on("keypress",c.commentingHandler)},renderOfferLightbox:function(){var c=a.handlers(),d=a(preparedObj.offerTempl(preparedObj.offers[b.offerId]));b.offerLightboxWrapNode.html(d),d.on("click",c.offerActionHandler),a(".js-answer").on("keypress",c.commentingHandler)}};return facadeOffer={like:function(){d.like(),d.sendData(),d.renderOfferCard(),d.renderOfferLightbox()},save:function(){d.save(),d.sendData(),d.renderOfferCard(),d.renderOfferLightbox()},viewComments:function(){d.viewMessages("hiddenComments")},viewAnswers:function(){d.viewMessages("hiddenAnswers")},openOfferLightbox:function(){d.toogleOfferLightbox(),d.renderOfferLightbox()},closeOfferLightbox:function(){d.toogleOfferLightbox()},addComment:function(a){d.addMessage("comments",a),d.sendData(),d.renderOfferCard()},addAnswer:function(a){d.addMessage("answers",a),d.sendData(),d.renderOfferCard(),d.renderOfferLightbox()},removeComment:function(){d.removeMessage("comments"),d.sendData(),d.renderOfferCard()},removeAnswer:function(){d.removeMessage("answers"),d.sendData(),d.renderOfferCard(),d.renderOfferLightbox()},removeOffer:function(){d.removeOffer(),d.sendData(),d.toogleOfferLightbox(),d.renderOffersCards()},renderOffersCards:function(){d.renderOffersCards()}}}}(jQuery);