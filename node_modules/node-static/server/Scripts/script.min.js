function getOffers(){$.ajax({method:"GET",url:"/offers.json",dataType:"json",cache:!1,success:function(a){$.each(a,function(){offers=a.slice()}),renderShortOffers()}})}function offerRefresh(){$.ajax({method:"POST",url:"/refresh",data:JSON.stringify(offers),dataType:"json",success:function(a){try{offers=a.slice()}catch(b){offerRefresh()}}})}function getLoggedUser(a){$.ajax({method:"POST",url:"/get-user",data:a,dataType:"json",success:function(a){user=a,renderTemplate("#user-plate-templ",".login-wrap .author",user),renderShortOffers()}})}function offerActionHandler(a){var b=$(a.target),c=b.attr("data-button")||b.parents("[data-button]").attr("data-button"),d=new Offer(this);switch(c){case"like":d.like();break;case"save":d.save();break;case"viewComment":d.viewComment(b);break;case"openOfferLightbox":d.openOfferLightbox();break;case"closeOfferLightbox":d.closeOfferLightbox();break;case"removeComment":d.removeComment(b.parents(".author"));break;case"removeAnswer":d.removeAnswer(b.parents(".author"));break;case"removeOffer":d.removeOffer()}}function commentingHandler(a){13!=a.keyCode&&13!=a.which||a.shiftKey||!this.value||($(this).hasClass("js-comment")&&new Offer($(this).parents(".offer-plate")).addComment(this.value),$(this).hasClass("js-answer")&&new Offer($(this).parents(".lightbox.offer")).addAnswer(this.value),$(this).val(""),a.preventDefault())}function Offer(a){function b(a){var b=!1;$.each(offers[f][a][0].fromUsers,function(c){return this.userId==user.id?(b=!0,offers[f][a][0].count-=1,offers[f][a][0].fromUsers.splice(c,1),!1):void 0}),b||(offers[f][a][0].count+=1,obj={userId:user.id,avatar:user.avatar},offers[f][a][0].fromUsers.push(obj))}function c(a,b){var c;c=offers[f][a][0].count?offers[f][a][0].fromUsers.last().id+1:0,obj={id:c,userId:user.id,avatar:user.avatar,comment:b},offers[f][a][0].count+=1,offers[f][a][0].fromUsers.push(obj)}function d(a,b){var c=offers[f][a][0].fromUsers,d=b.attr("data-id");$.each(c,function(b){return this.id==d?(removedObjects[0][a].push(this),offers[f][a][0].count-=1,c.splice(b,1),!1):void 0}),b.remove(),offerRefresh()}function e(){offerRefresh(),renderTemplate("#social-buttons-templ",'.offer-plate[data-id="'+h+'"] .social-actions',offers[f]),renderTemplate("#social-info-templ",'.offer-plate[data-id="'+h+'"] .social-info',offers[f]),renderTemplate("#lightbox-social-info-templ",'.lightbox.offer[data-id="'+h+'"] .lightbox-footer',offers[f]),renderTemplate("#lightbox-social-buttons-templ",'.lightbox.offer[data-id="'+h+'"] .social-actions',offers[f])}var f,g=$(a),h=g.attr("data-id");$.each(offers,function(a){return this.id==h?(f=a,!1):void 0}),this.like=function(){b("likes"),e()},this.save=function(){b("saved"),e()},this.viewComment=function(a){g.find(".comments").toggleClass("hidden"),a.toggleClass("active")},this.openOfferLightbox=function(){$("body").addClass("lock"),$(".lightbox-wrap").removeClass("hidden"),renderOffer(f)},this.closeOfferLightbox=function(){$("body").removeClass("lock"),$(".lightbox-wrap").addClass("hidden")},this.addComment=function(a){c("comments",a),offerRefresh(),renderTemplate("#social-info-templ",'.offer-plate[data-id="'+h+'"] .social-info',offers[f]),renderTemplate("#latest-comments-templ",'.offer-plate[data-id="'+h+'"] .latest-comments',offers[f])},this.addAnswer=function(a){c("answers",a),offerRefresh(),renderTemplate("#social-info-templ",'.offer-plate[data-id="'+h+'"] .social-info',offers[f]),renderTemplate("#latest-answers-templ",'.lightbox.offer[data-id="'+h+'"] .latest-comments',offers[f])},this.removeComment=function(a){d("comments",a),renderTemplate("#social-info-templ",'.offer-plate[data-id="'+h+'"] .social-info',offers[f]),renderTemplate("#latest-comments-templ",'.offer-plate[data-id="'+h+'"] .latest-comments',offers[f])},this.removeAnswer=function(a){d("answers",a),renderTemplate("#social-info-templ",'.offer-plate[data-id="'+h+'"] .social-info',offers[f]),renderTemplate("#latest-answers-templ",'.lightbox.offer[data-id="'+h+'"] .latest-comments',offers[f])},this.removeOffer=function(){this.closeOfferLightbox(),$('.offer-plate[data-id="'+h+'"]').remove(),removedObjects[0].offers.push(offers[f]),offers.splice(f,1),offerRefresh()}}function latestMessagesHelper(a,b,c,d){var e,f,g="";for(e=a.length-c;e<a.length;e++)a[e]&&(f=a[e].comment,d&&a[e].comment.length>d&&(a[e].comment=a[e].comment.slice(0,d)+"..."),g+=b.fn(a[e]),a[e].comment=f);return g}function addClassHelper(a,b,c,d,e){var f;return $.each(a,function(){return e&&this.userId!=user.id||!e&&this.userId==user.id?(a[c]=d,!1):void 0}),f=b.fn(a),delete a[c],f}function renderOffer(a){var b=Handlebars.compile($("#offer-templ").html());$(".lightbox-wrap").html(b(offers[a])),renderInputMessage("answer"),$(".lightbox.offer").on("click",offerActionHandler),$(".js-answer").on("keypress",commentingHandler)}function renderShortOffers(){var a,b,c=$(".column"),d=0;for(a=Handlebars.compile($("#offer-plate-templ").html()),$.each(c,function(){$(this).html("")});d<offers.length;)$.each(c,function(){var c,e;return $(this).append(a(offers[d])),c=$(this).find(".offer-img").last(),e=c.parent(),b=offers[d].id,c.width()>0&&c.width()<e.width()&&c.addClass("small"),d+=1,d>=offers.length?!1:void 0});renderInputMessage("comment"),$(".offer-plate").on("click",offerActionHandler),$(".js-comment").on("keypress",commentingHandler)}function renderInputMessage(a){var b,c,d;switch(a){case"comment":c="#add-comment-templ",d=".add-comment";break;case"answer":c="#add-answer-templ",d=".add-answer";break;default:return!1}b=Handlebars.compile($(c).html()),$(d).append(b(user))}function renderTemplate(a,b,c){var d;d=Handlebars.compile($(a).html()),$(b).html(d(c))}var offers=[],user={fullname:"Гость",avatar:"../../../images/users/anonymous.png"};$(".login .button").on("click",function(){getLoggedUser($(".login .field-text").val())}),getOffers(),Array.prototype.last=function(){return this[this.length-1]};var removedObjects=[{offers:[],comments:[],answers:[]}];Handlebars.registerHelper("renderLatestMessages",function(a,b,c){var d,e;switch(b){case"comments":d=5,e=40;break;case"answers":d=3}return latestMessagesHelper(a,c,d,e)}),Handlebars.registerHelper("renderCloseElement",function(a,b){return a==user.id?b.fn(a):void 0}),Handlebars.registerHelper("like",function(a,b){return addClassHelper(a,b,"liked","active")}),Handlebars.registerHelper("save",function(a,b){return addClassHelper(a,b,"saved","active")}),Handlebars.registerHelper("renderButtonRemoveOffer",function(a,b){return addClassHelper(a,b,"hidden","hidden",!0)}),Handlebars.registerHelper("renderCountActions",function(a,b){return a?b.fn(a):void 0});