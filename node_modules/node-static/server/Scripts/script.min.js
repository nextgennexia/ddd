function getOffers(){$.ajax({type:"GET",url:"offers.json",success:function(a){$.each(a,function(){offers.push(this)}),renderShortOffers()}})}function offerRefresh(){$.ajax({type:"POST",data:JSON.stringify(offers),url:"/refresh",contentType:"application/json",success:function(a){try{offers=JSON.parse(a).slice()}catch(b){offerRefresh()}}})}function getLoggedUser(a){$.ajax({type:"POST",data:a,url:"/getUser",contentType:"application/json",success:function(a){user=JSON.parse(a),renderLoggedUser(),renderShortOffers()}})}function offerActionHandler(a){var b=$(a.target),c=b.attr("data-button"),d=new Offer(this);switch(c){case"like":d.like();break;case"save":d.save();break;case"viewComment":d.viewComment(b);break;case"openOfferLightbox":d.openOfferLightbox();break;case"closeOfferLightbox":d.closeOfferLightbox();break;case"removeComment":d.removeComment(b.parents(".author"));break;case"removeAnswer":d.removeAnswer(b.parents(".author"));break;case"removeOffer":d.removeOffer()}}function commentingHandler(a){13==a.charCode&&this.value&&($(this).hasClass("js-comment")&&new Offer($(this).parents(".offer-plate")).addComment(this.value),$(this).hasClass("js-answer")&&new Offer($(this).parents(".lightbox.offer")).addAnswer(this.value))}function Offer(a){function b(a){$.each(offers[f][a][0].fromUsers,function(b){return this.userId==user.id?(g=!0,offers[f][a][0].count-=1,offers[f][a][0].fromUsers.splice(b,1),offerRefresh(),renderShortOffers(),renderOffer(f),!1):void 0}),g||(offers[f][a][0].count+=1,obj={userId:user.id,avatar:user.avatar},offers[f][a][0].fromUsers.push(obj),offerRefresh(),renderShortOffers(),renderOffer(f))}function c(a,b){var c;c=offers[f][a][0].count?offers[f][a][0].fromUsers.last().id+1:0,obj={id:c,userId:user.id,avatar:user.avatar,comment:b},offers[f][a][0].count+=1,offers[f][a][0].fromUsers.push(obj),offerRefresh(),renderShortOffers(),renderOffer(f)}function d(a,b){var c=offers[f][a][0].fromUsers,d=b.attr("data-id");$.each(c,function(b){return c[b].id==d?(removedObjects[0][a].push(c[b]),offers[f][a][0].count-=1,c.splice(b,1),!1):void 0}),b.remove(),offerRefresh()}var e=$(a),f=e.attr("data-id"),g=!1;this.like=function(){b("likes")},this.save=function(){b("saved")},this.viewComment=function(a){e.find(".comments").toggleClass("hidden"),a.toggleClass("active")},this.openOfferLightbox=function(){$("body").addClass("lock"),$(".lightbox-wrap").removeClass("hidden"),renderOffer(f)},this.closeOfferLightbox=function(){$("body").removeClass("lock"),$(".lightbox-wrap").addClass("hidden")},this.addComment=function(a){c("comments",a)},this.addAnswer=function(a){c("answers",a)},this.removeComment=function(a){d("comments",a)},this.removeAnswer=function(a){d("answers",a)},this.removeOffer=function(){$.each(offers,function(a){return offers[a].id==f?(removedObjects[0].offers.push(offers[a]),offers.splice(a,1),!1):void 0}),$(".lightbox-wrap").toggleClass("hidden"),$('.offer-plate[data-id="'+f+'"]').remove(),offerRefresh()}}function latestMessagesHelper(a,b,c,d){var e,f,g="";for(e=a.length<c?0:a.length-c;e<a.length;e++)f=a[e].comment,d&&a[e].comment.length>d&&(a[e].comment=a[e].comment.slice(0,d)+"..."),g+=b.fn(a[e]),a[e].comment=f;return g}function addClassHelper(a,b,c,d,e){var f;return $.each(a,function(b){e&&a[b].userId!=user.id&&(a[c]=d),e||a[b].userId!=user.id||(a[c]=d)}),f=b.fn(a),delete a[c],f}function renderOffer(a){var b=Handlebars.compile($("#offer-templ").html());$.each(offers,function(c){offers[c].id==a&&$(".lightbox-wrap").html(b(offers[c]))}),renderAddMessage("answer"),$(".lightbox.offer").on("click",offerActionHandler),$(".js-answer").on("keypress",commentingHandler)}function renderShortOffers(){var a,b=$(".column"),c=0;for(a=Handlebars.compile($("#offer-plate-templ").html()),$.each(b,function(a){$(this).html("")});c<offers.length;)$.each(b,function(){return $(this).append(a(offers[c])),c+=1,c>=offers.length?!1:void 0});renderAddMessage("comment"),$(".offer-plate").on("click",offerActionHandler),$(".js-comment").on("keypress",commentingHandler)}function renderAddMessage(a){var b,c,d;switch(a){case"comment":c="#add-comment-templ",d=".add-comment";break;case"answer":c="#add-answer-templ",d=".add-answer";break;default:return!1}b=Handlebars.compile($(c).html()),$(d).append(b(user))}function renderLoggedUser(){var a;a=Handlebars.compile($("#user-plate-templ").html()),$(".login-wrap .author").html(a(user))}var offers=[],user={fullname:"Гость",avatar:"../../../images/users/anonim.png"};$(".login .button").on("click",function(){var a=$(".login .field-text").val();a&&getLoggedUser(a)}),getOffers(),Array.prototype.last=function(){return this[this.length-1]};var removedObjects=[{offers:[],comments:[],answers:[]}];Handlebars.registerHelper("renderLatestComments",function(a,b){return latestMessagesHelper(a,b,5,40)}),Handlebars.registerHelper("renderLatestAnswers",function(a,b){return latestMessagesHelper(a,b,3)}),Handlebars.registerHelper("renderCloseElement",function(a,b){var c;return a&&a==user.id&&(c=b.fn(a)),c}),Handlebars.registerHelper("like",function(a,b){return addClassHelper(a,b,"liked","active")}),Handlebars.registerHelper("save",function(a,b){return addClassHelper(a,b,"saved","active")}),Handlebars.registerHelper("renderButtonRemoveOffer",function(a,b){return addClassHelper(a,b,"hidden","hidden",!0)}),Handlebars.registerHelper("renderCountActions",function(a,b){var c;return 0!=a&&(c=b.fn(a)),c});