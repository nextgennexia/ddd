function getLoggedUser(a){$.post("/get-user",a,function(a){$.each(preparedObj.offers,function(){this.user=a}),renderUser(preparedObj.userTempl),renderOffersCards(preparedObj.offerCardTempl)},"json","text/plain")}function offerActionHandler(a){var b=$(a.target),c=b.attr("data-button")||b.parents("[data-button]").attr("data-button"),d=new Offer(this);switch(c){case"like":d.like();break;case"save":d.save();break;case"viewComment":d.viewComment(b,"comment");break;case"viewAnswer":d.viewComment(b,"answer");break;case"openOfferLightbox":d.openOfferLightbox();break;case"closeOfferLightbox":d.closeOfferLightbox();break;case"removeComment":d.removeComment(b.parents(".author"));break;case"removeAnswer":d.removeAnswer(b.parents(".author"));break;case"removeOffer":d.removeOffer()}}function commentingHandler(a){13!=a.keyCode&&13!=a.which||a.shiftKey||!this.value||($(this).hasClass("js-comment")&&new Offer($(this).parents(".js-offer-card-wrap")).addComment(this.value),$(this).hasClass("js-answer")&&new Offer($(this).parents(".lightbox.offer")).addAnswer(this.value),$(this).val(""),a.preventDefault())}function Offer(a){function b(a){var b=!1;$.each(preparedObj.offers[f][a][0].fromUsers,function(c){return this.userId==preparedObj.offers[f].user.id?(b=!0,preparedObj.offers[f][a][0].count-=1,preparedObj.offers[f][a][0].fromUsers.splice(c,1),!1):void 0}),b||(preparedObj.offers[f][a][0].count+=1,obj={userId:preparedObj.offers[f].user.id,avatar:preparedObj.offers[f].user.avatar},preparedObj.offers[f][a][0].fromUsers.push(obj))}function c(a,b){var c;c=preparedObj.offers[f][a][0].count?preparedObj.offers[f][a][0].fromUsers.last().id+1:0,obj={id:c,userId:preparedObj.offers[f].user.id,avatar:preparedObj.offers[f].user.avatar,comment:b},preparedObj.offers[f][a][0].count+=1,preparedObj.offers[f][a][0].fromUsers.push(obj)}function d(a,b){var c=preparedObj.offers[f][a][0].fromUsers,d=b.attr("data-id");$.each(c,function(b){return this.id==d?(preparedObj.offers[f][a][0].count-=1,c[b].removed=!0,!1):void 0}),b.remove()}function e(){$.ajax({method:"POST",url:"/refresh",data:JSON.stringify(preparedObj.offers),dataType:"json",success:function(a){try{offers=a.slice()}catch(b){e()}}})}var f,g=$(a),h=g.attr("data-id");$.each(preparedObj.offers,function(a){return this.id==h?(f=a,!1):void 0}),this.like=function(){b("likes"),e(),renderOfferCard(preparedObj.offerCardTempl,f),renderOffer(preparedObj.offerTempl,f)},this.save=function(){b("saved"),e(),renderOfferCard(preparedObj.offerCardTempl,f),renderOffer(preparedObj.offerTempl,f)},this.viewComment=function(a,b){"comment"==b&&(preparedObj.offers[f].states.hiddenComments=!preparedObj.offers[f].states.hiddenComments),"answer"==b&&(preparedObj.offers[f].states.hiddenAnswers=!preparedObj.offers[f].states.hiddenAnswers),g.find(".comments").toggleClass("hidden"),a.toggleClass("active")},this.openOfferLightbox=function(){$("body").addClass("lock"),$(".lightbox-wrap").removeClass("hidden"),renderOffer(preparedObj.offerTempl,f)},this.closeOfferLightbox=function(){$("body").removeClass("lock"),$(".lightbox-wrap").addClass("hidden")},this.addComment=function(a){c("comments",a),e(),renderOfferCard(preparedObj.offerCardTempl,f)},this.addAnswer=function(a){c("answers",a),e(),renderOfferCard(preparedObj.offerCardTempl,f),renderOffer(preparedObj.offerTempl,f)},this.removeComment=function(a){d("comments",a),e(),renderOfferCard(preparedObj.offerCardTempl,f)},this.removeAnswer=function(a){d("answers",a),e(),renderOfferCard(preparedObj.offerCardTempl,f),renderOffer(preparedObj.offerTempl,f)},this.removeOffer=function(){preparedObj.offers[f].removed=!0,e(),this.closeOfferLightbox(),renderOffersCards(preparedObj.offerCardTempl)}}function init(){preparedObj.offerCardTempl=Handlebars.compile($("#offer-card-templ").html()),preparedObj.offerTempl=Handlebars.compile($("#offer-templ").html()),preparedObj.userTempl=Handlebars.compile($("#user-plate-templ").html()),$.get("/offers.json",function(a){preparedObj.offers=a.slice(),$.each(preparedObj.offers,function(){this.states={hiddenComments:!0,hiddenAnswers:!0},this.user={fullname:"Гость",avatar:"../../../images/users/anonymous.png"}}),renderOffersCards(preparedObj.offerCardTempl)},"json")}function renderOffersCards(a){var b,c=$(".column"),d=0;for($.each(c,function(){$(this).html("")});d<preparedObj.offers.length;)for(b=0;b<c.length;b++)if(preparedObj.offers[d].removed)d++,b--;else if($(c[b]).append(a(preparedObj.offers[d])),d++,d>=preparedObj.offers.length)break;$(".js-offer-card-wrap").on("click",offerActionHandler),$(".js-comment").on("keypress",commentingHandler)}function renderOfferCard(a,b){$('.js-offer-card-wrap[data-id="'+b+'"]').replaceWith(a(preparedObj.offers[b])),$('.js-offer-card-wrap[data-id="'+b+'"]').on("click",offerActionHandler),$('.js-offer-card-wrap[data-id="'+b+'"] .js-comment').on("keypress",commentingHandler)}function renderOffer(a,b){$(".lightbox-wrap").html(a(preparedObj.offers[b])),$(".lightbox.offer").on("click",offerActionHandler),$(".js-answer").on("keypress",commentingHandler)}function renderUser(a){$(".login-wrap .author").html(a(preparedObj.offers[0].user))}Array.prototype.last=function(){return this[this.length-1]},$(".login .button").on("click",function(){getLoggedUser($(".login .field-text").val())});var preparedObj=[];init(),Handlebars.registerHelper("ifCond",function(a,b,c,d){switch(b){case"!=":return a!=c?d.fn(this):d.inverse(this);case"==":return a==c?d.fn(this):d.inverse(this);case"===":return a===c?d.fn(this):d.inverse(this);case"<":return c>a?d.fn(this):d.inverse(this);case"<=":return c>=a?d.fn(this):d.inverse(this);case">":return a>c?d.fn(this):d.inverse(this);case">=":return a>=c?d.fn(this):d.inverse(this);case"&&":return a&&c?d.fn(this):d.inverse(this);case"||":return a||c?d.fn(this):d.inverse(this);default:return d.inverse(this)}}),Handlebars.registerHelper("renderLatestMessages",function(a,b,c,d){var e,f="",g=0,h=a.length-1;for(g;b>g;g++)if(a[h]){if(a[h].removed){h--,g--;continue}e=a[h].comment,c&&a[h].comment.length>c&&(a[h].comment=a[h].comment.slice(0,c)+"..."),f=d.fn(a[h])+f,a[h].comment=e,h--}return f});