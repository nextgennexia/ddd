Array.prototype.last = function () {
  return this[this.length - 1];
}

$('.login .button').on('click', function () {
  getLoggedUser($('.login .field-text').val());
});

function getLoggedUser(id) {
  $.post('/get-user', id, function (data) {

    $.each(preparedObj.offers, function () {
      this.user = data;
    });

    renderUser(preparedObj.userTempl);
    renderOffersCards(preparedObj.offerCardTempl);
  }, 'json', 'text/plain');
};

function offerActionHandler(e) {
  var
    $target = $(e.target),
    button = $target.attr('data-button') || $target.parents('[data-button]').attr('data-button'),
    offer = new Offer(this);

  switch (button) {
    case 'like':
      offer.like();
      break;
    case 'save':
      offer.save();
      break;
    case 'viewComment':
      offer.viewComment($target, 'comment');
      break;
    case 'viewAnswer':
      offer.viewComment($target, 'answer');
      break;
    case 'openOfferLightbox':
      offer.openOfferLightbox();
      break;
    case 'closeOfferLightbox':
      offer.closeOfferLightbox();
      break;
    case 'removeComment':
      offer.removeComment($target.parents('.author'));
      break;
    case 'removeAnswer':
      offer.removeAnswer($target.parents('.author'));
      break;
    case 'removeOffer':
      offer.removeOffer();
      break;
  }
}

function commentingHandler(e) {
  if (((e.keyCode == 13 || e.which == 13) && !e.shiftKey) && this.value) {
    if ($(this).hasClass('js-comment')) {
      new Offer($(this).parents('.js-offer-card-wrap')).addComment(this.value);
    }
    if ($(this).hasClass('js-answer')) {
      new Offer($(this).parents('.lightbox.offer')).addAnswer(this.value);
    }

    $(this).val('');
    e.preventDefault();
  }
}

function Offer(self) {
  var
    $offer = $(self),
    offerId = $offer.attr('data-id'),
    offerIndex;

  $.each(preparedObj.offers, function (i) {
    if (this.id == offerId) {
      offerIndex = i;
      return false;
    }
  });

  this.like = function () {
    countActions('likes');
    sendData();
    renderOfferCard(preparedObj.offerCardTempl, offerIndex);
    renderOffer(preparedObj.offerTempl, offerIndex);
  }

  this.save = function () {
    countActions('saved');
    sendData();
    renderOfferCard(preparedObj.offerCardTempl, offerIndex);
    renderOffer(preparedObj.offerTempl, offerIndex);
  }

  this.viewComment = function ($target, subject) {
    if (subject == 'comment') {
      preparedObj.offers[offerIndex].states.hiddenComments = !preparedObj.offers[offerIndex].states.hiddenComments;
    }
    if (subject == 'answer') {
      preparedObj.offers[offerIndex].states.hiddenAnswers = !preparedObj.offers[offerIndex].states.hiddenAnswers;
    }
    
    $offer.find('.comments').toggleClass('hidden');
    $target.toggleClass('active');
  }

  this.openOfferLightbox = function () {
    $('body').addClass('lock');
    $('.lightbox-wrap').removeClass('hidden');
    renderOffer(preparedObj.offerTempl, offerIndex);
  }

  this.closeOfferLightbox = function () {
    $('body').removeClass('lock');
    $('.lightbox-wrap').addClass('hidden');
  }

  this.addComment = function (comment) {
    addMessage('comments', comment);
    sendData();
    renderOfferCard(preparedObj.offerCardTempl, offerIndex);
  }

  this.addAnswer = function (answer) {
    addMessage('answers', answer);
    sendData();
    renderOfferCard(preparedObj.offerCardTempl, offerIndex);
    renderOffer(preparedObj.offerTempl, offerIndex);
  }

  this.removeComment = function ($commentElem) {
    removeMessage('comments', $commentElem);
    sendData();
    renderOfferCard(preparedObj.offerCardTempl, offerIndex);
  }

  this.removeAnswer = function ($answerElem) {
    removeMessage('answers', $answerElem);
    sendData();
    renderOfferCard(preparedObj.offerCardTempl, offerIndex);
    renderOffer(preparedObj.offerTempl, offerIndex);
  }

  this.removeOffer = function () {
    preparedObj.offers[offerIndex].removed = true;
    sendData();
    this.closeOfferLightbox();
    renderOffersCards(preparedObj.offerCardTempl);
  }

  function countActions(subject) {
    var hasAction = false;

    $.each(preparedObj.offers[offerIndex][subject][0].fromUsers, function (i) {
      if (this.userId == preparedObj.offers[offerIndex].user.id) {
        hasAction = true;
        preparedObj.offers[offerIndex][subject][0].count -= 1;
        preparedObj.offers[offerIndex][subject][0].fromUsers.splice(i, 1);
        return false;
      }
    });

    if (!hasAction) {
      preparedObj.offers[offerIndex][subject][0].count += 1;
      obj = {
        userId: preparedObj.offers[offerIndex].user.id,
        avatar: preparedObj.offers[offerIndex].user.avatar
      }
      preparedObj.offers[offerIndex][subject][0].fromUsers.push(obj);
    }
  }

  function addMessage(subject, message) {
    var currentId;

    if (!preparedObj.offers[offerIndex][subject][0].count) {
      currentId = 0
    } else {
      currentId = preparedObj.offers[offerIndex][subject][0].fromUsers.last().id + 1;
    }

    obj = {
      id: currentId,
      userId: preparedObj.offers[offerIndex].user.id,
      avatar: preparedObj.offers[offerIndex].user.avatar,
      comment: message
    }

    preparedObj.offers[offerIndex][subject][0].count += 1;
    preparedObj.offers[offerIndex][subject][0].fromUsers.push(obj);
  }

  function removeMessage(subject, $messageElem) {
    var
        comments = preparedObj.offers[offerIndex][subject][0].fromUsers,
        commentId = $messageElem.attr('data-id');

    $.each(comments, function (i) {
      if (this.id == commentId) {
        preparedObj.offers[offerIndex][subject][0].count -= 1;
        comments[i].removed = true;
        return false;
      }
    })

    $messageElem.remove();
  }

  function sendData() {
    $.ajax({
      method: 'POST',
      url: '/refresh',
      data: JSON.stringify(preparedObj.offers),
      dataType: 'json',
      success: function (data) {
        try {
          offers = data.slice();
        } catch (e) {
          sendData();
        }
      }
    });
  }
}
