var offerCard = (function () {

  function _addMessage(subject, offerId, message) {
    preparedObj.offers[offerId][subject].push({
      id: preparedObj.offers[offerId][subject].length,
      userId: preparedObj.offers[offerId].user.id,
      avatar: preparedObj.offers[offerId].user.avatar,
      comment: message
    });
  };

  function _countActions(subject, offerId) {
    var _hasAction = false;

    $.each(preparedObj.offers[offerId][subject], function (i) {
      if (this.userId == preparedObj.offers[offerId].user.id) {
        _hasAction = true;
        preparedObj.offers[offerId][subject].splice(i, 1);
        return false;
      }
    });

    if (!_hasAction) {
      preparedObj.offers[offerId][subject].push({
        userId: preparedObj.offers[offerId].user.id,
        avatar: preparedObj.offers[offerId].user.avatar
      });
    }
  };

  function _toogleView(subject, offerId, switcher) {
    if (switcher === true) {
      preparedObj.offers[offerId].states[subject] = false;
    } else if (switcher === false) {
      preparedObj.offers[offerId].states[subject] = true;
    } else {
      preparedObj.offers[offerId].states[subject] = !preparedObj.offers[offerId].states[subject];
    }
  }

  return {
    like: function (offerId) {
      _countActions('likes', offerId);
    },
    save: function (offerId) {
      _countActions('saved', offerId);
    },
    viewComments: function (offerId) {
      _toogleView('hiddenComments', offerId);
    },
    viewAnswers: function (offerId) {
      _toogleView('hiddenAnswers', offerId);
    },
    addComment: function (offerId, message) {
      _addMessage('comments', offerId, message);
    },
    addAnswer: function (offerId, message) {
      _addMessage('answers', offerId, message);
    },
    removeComment: function (offerId, messageId) {
      preparedObj.offers[offerId].comments[messageId].removed = true;
    },
    removeAnswer: function (offerId, messageId) {
      preparedObj.offers[offerId].answers[messageId].removed = true;
    },
    openOfferLightbox: function (offerId) {
      _toogleView('hiddenOfferLightbox', offerId, true);
      $('body').addClass('lock');
      offerCard.renderOfferLightbox(offerId);
    },
    closeOfferLightbox: function (offerId) {
      _toogleView('hiddenOfferLightbox', offerId, false);
      $('body').removeClass('lock');
      offerCard.renderOfferLightbox(offerId);
    },
    removeOffer: function (offerId) {
      preparedObj.offers[offerId].removed = true;
    },
    sendData: function () {
      $.ajax({
        method: 'POST',
        url: '/refresh',
        data: JSON.stringify(preparedObj.offers),
        dataType: 'json',
        success: function (data) {
          try {
            preparedObj.offers = data.slice();
          } catch (e) {
            sendData();
          }
        }
      });
    },
    renderOffersCards: function () {
      var
        _columns = $('.column'),
        _offerIndex = 0;

      $.each(_columns, function () {
        $(this).html('');
      });

      $.each(preparedObj.offers, function (index, item) {
        if (!item.removed) {
          if (_offerIndex > 3) {
            _offerIndex = 0;
          }
          $(_columns[_offerIndex]).append(preparedObj.offerCardTempl(item));
          _offerIndex++;
        }
      });
    },
    renderOfferCard: function (offerId) {
      $('.js-offer-wrap[data-offer-id="' + offerId + '"]').replaceWith(preparedObj.offerCardTempl(preparedObj.offers[offerId]));
    },
    renderOfferLightbox: function (offerId) {
      $('.lightboxes').html(preparedObj.offerTempl(preparedObj.offers[offerId]));
    }
  };
})();