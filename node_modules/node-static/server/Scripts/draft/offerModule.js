(function ($) {
  $.offerCard = function (params, callback) {
    var offer = {
      params: $.extend(params),
      like: function () {
        offer.countActions('likes');
      },
      save: function () {
        offer.countActions('saved');
      },
      viewMessages: function (subject) {
        preparedObj.offers[params.offerId].states[subject] = !preparedObj.offers[params.offerId].states[subject];
        params.offerNode.find('.comments').toggleClass('hidden');
        params.targetNode.toggleClass('active');
      },
      toogleOfferLightbox: function () {
        $('body').toggleClass('lock');
        params.offerLightboxWrapNode.toggleClass('hidden');
      },
      addMessage: function (subject, message) {
        var currentId;

        if (!preparedObj.offers[params.offerId][subject][0].count) {
          currentId = 0
        } else {
          currentId = preparedObj.offers[params.offerId][subject][0].fromUsers.last().id + 1;
        }

        obj = {
          id: currentId,
          userId: preparedObj.offers[params.offerId].user.id,
          avatar: preparedObj.offers[params.offerId].user.avatar,
          comment: message
        }

        preparedObj.offers[params.offerId][subject][0].count += 1;
        preparedObj.offers[params.offerId][subject][0].fromUsers.push(obj);
      },
      removeMessage: function (subject) {
        $.each(preparedObj.offers[params.offerId][subject][0].fromUsers, function () {
          if (this.id == params.targetNode.parents('.author').attr('data-id')) {
            preparedObj.offers[params.offerId][subject][0].count -= 1;
            this.removed = true;
            return false;
          }
        });
      },
      removeOffer: function () {
        preparedObj.offers[params.offerId].removed = true;
      },
      countActions: function (subject) {
        var hasAction = false;

        $.each(preparedObj.offers[params.offerId][subject][0].fromUsers, function (i) {
          if (this.userId == preparedObj.offers[params.offerId].user.id) {
            hasAction = true;
            preparedObj.offers[params.offerId][subject][0].count -= 1;
            preparedObj.offers[params.offerId][subject][0].fromUsers.splice(i, 1);
            return false;
          }
        });

        if (!hasAction) {
          preparedObj.offers[params.offerId][subject][0].count += 1;
          obj = {
            userId: preparedObj.offers[params.offerId].user.id,
            avatar: preparedObj.offers[params.offerId].user.avatar
          }
          preparedObj.offers[params.offerId][subject][0].fromUsers.push(obj);
        }
      },
      sendData: function () {
        $.ajax({
          method: 'POST',
          url: '/refresh',
          data: JSON.stringify(preparedObj.offers),
          dataType: 'json',
          success: function (data) {
            try {
              preparedObj.offers = data.slice();
            } catch (e) {
              sendData();
            }
          }
        });
      },
      renderOffersCards: function () {
        var
          columns = $('.column'),
          $templ,
          handlers = $.handlers(),
          offerIndex = 0,
          i;

       $.each(columns, function () {
          $(this).html('');
        });

        while (offerIndex < preparedObj.offers.length) {
          for (i = 0; i < columns.length; i++) {
            if (preparedObj.offers[offerIndex].removed) {
              offerIndex++;
              i--;
              continue;
            }
            $templ = $(preparedObj.offerCardTempl(preparedObj.offers[offerIndex]));
            $(columns[i]).append($templ);
            $templ.on('click', handlers.offerActionHandler);
            offerIndex++;
            if (offerIndex >= preparedObj.offers.length) break;
          }
        }
      },
      renderOfferCard: function () {
        var
          handlers = $.handlers(),
          $templ = $(preparedObj.offerCardTempl(preparedObj.offers[params.offerId]));

        params.offerNode.replaceWith($templ);
        $templ.on('click', handlers.offerActionHandler);
        $('.js-offer-card-wrap[data-id="' + params.offerId + '"] .js-comment').on('keypress', handlers.commentingHandler);
      },
      renderOfferLightbox: function () {
        var
          handlers = $.handlers(),
          $templ = $(preparedObj.offerTempl(preparedObj.offers[params.offerId]));

        params.offerLightboxWrapNode.html($templ);
        $templ.on('click', handlers.offerActionHandler);
        $('.js-answer').on('keypress', handlers.commentingHandler);
      }
    };

    return facadeOffer = {
      like: function () {
        offer.like();
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      save: function () {
        offer.save();
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      viewComments: function () {
        offer.viewMessages('hiddenComments');
      },
      viewAnswers: function () {
        offer.viewMessages('hiddenAnswers');
      },
      openOfferLightbox: function(){
        offer.toogleOfferLightbox();
        offer.renderOfferLightbox();
      },
      closeOfferLightbox: function () {
        offer.toogleOfferLightbox();
      },
      addComment: function (msg) {
        offer.addMessage('comments', msg);
        offer.sendData();
        offer.renderOfferCard();
      },
      addAnswer: function (msg) {
        offer.addMessage('answers', msg);
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      removeComment: function () {
        offer.removeMessage('comments');
        offer.sendData();
        offer.renderOfferCard();
      },
      removeAnswer: function () {
        offer.removeMessage('answers');
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      removeOffer: function () {
        offer.removeOffer();
        offer.sendData();
        offer.toogleOfferLightbox();
        offer.renderOffersCards();
      },
      renderOffersCards: function () {
        offer.renderOffersCards();
      }
    };
  }
})(jQuery);