var preparedObj = [];

(function () {
  preparedObj.offerCardTempl = Handlebars.compile($('#offer-card-templ').html());
  preparedObj.offerTempl = Handlebars.compile($('#offer-templ').html());
  preparedObj.userTempl = Handlebars.compile($('#user-plate-templ').html());

  $.get('/offers.json', function (data) {
    preparedObj.offers = data.slice();

    $.each(preparedObj.offers, function () {
      this.states = {
        hiddenComments: true,
        hiddenAnswers: true
      };
      this.user = {
        fullname: 'Гость',
        avatar: '../../../images/users/anonymous.png'
      };
    });

    renderUser(preparedObj.userTempl);
    renderOffersCards(preparedObj.offerCardTempl);
  }, 'json');
})();

(function ($) {
  $.handlers = function () {

    var handlers = {
      loginHandler: function () {
        getLoggedUser($('.login .field-text').val());
      },
      offerActionHandler: function (e) {
        var
          targetNode = $(e.target),
          button = targetNode.attr('data-button') || targetNode.parents('[data-button]').attr('data-button'),
          offerNode = $(this),
          offerId = offerNode.attr('data-id'),
          offerCard = $.offerCard({
            offerId: offerId,
            targetNode: targetNode,
            offerNode: offerNode
          });

        switch (button) {
          case 'like':
            offerCard.like();
            offerCard.sendData();
            if (offerNode.hasClass('lightbox offer')) {
              renderOffer(preparedObj.offerTempl, offerId);
            }
            renderOfferCard(preparedObj.offerCardTempl, offerId);
            break;
          case 'save':
            offerCard.save();
            offerCard.sendData();
            if (offerNode.hasClass('lightbox offer')) {
              renderOffer(preparedObj.offerTempl, offerId);
            }
            renderOfferCard(preparedObj.offerCardTempl, offerId);
            break;
          case 'viewComment':
            offerCard.viewComments('hiddenComments');
            break;
          case 'viewAnswer':
            offerCard.viewComments('hiddenAnswers');
            break;
          case 'openOfferLightbox':
            offerCard.toogleOfferLightbox();
            renderOffer(preparedObj.offerTempl, offerId);
            break;
          case 'closeOfferLightbox':
            offerCard.toogleOfferLightbox();
            break;
          case 'removeComment':
            offerCard.removeMessage('comments');
            offerCard.sendData();
            renderOfferCard(preparedObj.offerCardTempl, offerId);
            break;
          case 'removeAnswer':
            offerCard.removeMessage('answers');
            offerCard.sendData();
            renderOfferCard(preparedObj.offerCardTempl, offerId);
            renderOffer(preparedObj.offerTempl, offerId);
            break;
          case 'removeOffer':
            offerCard.removeOffer();
            offerCard.sendData();
            offerCard.toogleOfferLightbox();
            renderOffersCards(preparedObj.offerCardTempl);
            break;
        }
      },
      commentingHandler: function (e) {
        var
         offerId = $(this).attr('data-id'),
         offerCard = $.offerCard({
           offerId: offerId
         });

        if (((e.keyCode == 13 || e.which == 13) && !e.shiftKey) && this.value) {
          if ($(this).hasClass('js-comment')) {
            offerCard.addMessage('comments', this.value);
            offerCard.sendData();
            renderOfferCard(preparedObj.offerCardTempl, offerId);
          }
          if ($(this).hasClass('js-answer')) {
            offerCard.addMessage('answers', this.value);
            offerCard.sendData();
            renderOfferCard(preparedObj.offerCardTempl, offerId);
            renderOffer(preparedObj.offerTempl, offerId);
          }

          $(this).val('');
          e.preventDefault();
        }
      }
    }

    return {
      loginHandler: handlers.loginHandler,
      offerActionHandler: handlers.offerActionHandler,
      commentingHandler: handlers.commentingHandler
    }
  };
})(jQuery);