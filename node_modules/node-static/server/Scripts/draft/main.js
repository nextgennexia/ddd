var preparedObj = [];

Array.prototype.last = function () {
  return this[this.length - 1];
};

(function () {
  preparedObj.offerCardTempl = Handlebars.compile($('#offer-card-templ').html());
  preparedObj.offerTempl = Handlebars.compile($('#offer-templ').html());
  preparedObj.userTempl = Handlebars.compile($('#user-plate-templ').html());

  $.get('/offers.json', function (data) {
    preparedObj.offers = data.slice();

    $.each(preparedObj.offers, function () {
      this.states = {
        hiddenComments: true,
        hiddenAnswers: true,
        hiddenOfferLightbox: true
      };
      this.user = {
        fullname: 'Гость',
        avatar: '../../../images/users/anonymous.png'
      };
    });

    $('.js-auth').on('click', handling.loginHandler);
    $('.offer-plates').on({
      'click': handling.offerActionHandler,
      'keypress': handling.commentingHandler
    });
    $('.lightboxes').on({
      'click': handling.offerActionHandler,
      'keypress': handling.commentingHandler
    });

    login.renderUser();
    offerCard.renderOffersCards();
  }, 'json');
})();

var handling = (function () {
  return {
    loginHandler: function(){
      login.authorize($('.js-login').val(), function () {
        offerCard.renderOffersCards();
      });
    },
    offerActionHandler: function (e) {
      var
        _$target = $(e.target),
        _button = _$target.attr('data-button') || _$target.parents('[data-button]').attr('data-button'),
        _messageId = _$target.parents('.author').attr('data-message-id'),
        _offerId = _$target.parents('[data-offer-id]').attr('data-offer-id');

      switch (_button) {
        case 'like':
          offerCard.like(_offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
          break;
        case 'like-lbx':
          offerCard.like(_offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
          offerCard.renderOfferLightbox(_offerId);
          break;
        case 'save':
          offerCard.save(_offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
          break;
        case 'save-lbx':
          offerCard.save(_offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
          offerCard.renderOfferLightbox(_offerId);
          break;
        case 'viewComment':
          offerCard.viewComments(_offerId);
          offerCard.renderOfferCard(_offerId);
          break;
        case 'viewAnswer':
          offerCard.viewAnswers(_offerId);
          offerCard.renderOfferLightbox(_offerId);
          break;
        case 'openOfferLightbox':
          offerCard.openOfferLightbox(_offerId);
          break;
        case 'closeOfferLightbox':
          offerCard.closeOfferLightbox(_offerId);
          break;
        case 'removeComment':
          offerCard.removeComment(_offerId, _messageId);
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
          break;
        case 'removeAnswer':
          offerCard.removeAnswer(_offerId, _messageId);
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
          offerCard.renderOfferLightbox(_offerId);
          break;
        case 'removeOffer':
          offerCard.removeOffer(_offerId);
          offerCard.sendData();
          offerCard.closeOfferLightbox(_offerId);
          offerCard.renderOffersCards();
          break;
      }
    },
    commentingHandler: function (e) {
      var
        _$target = $(e.target),
        _offerId = _$target.parents('[data-offer-id]').attr('data-offer-id');

      if (((e.keyCode == 13 || e.which == 13) && !e.shiftKey) && _$target.val()) {
        if (_$target.hasClass('js-comment')) {
          offerCard.addComment(_offerId, _$target.val());
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
        }
        if (_$target.hasClass('js-answer')) {
          offerCard.addAnswer(_offerId, _$target.val());
          offerCard.sendData();
          offerCard.renderOfferCard(_offerId);
          offerCard.renderOfferLightbox(_offerId);
        }

        _$target.val('');
        e.preventDefault();
      }
    }
  }
})();