var preparedObj = [];

Array.prototype.last = function () {
  return this[this.length - 1];
};

(function () {
  preparedObj.offerCardTempl = Handlebars.compile($('#offer-card-templ').html());
  preparedObj.offerTempl = Handlebars.compile($('#offer-templ').html());
  preparedObj.userTempl = Handlebars.compile($('#user-plate-templ').html());

  $.get('/offers.json', function (data) {
    preparedObj.offers = data.slice();

    $.each(preparedObj.offers, function () {
      this.states = {
        hiddenComments: true,
        hiddenAnswers: true,
        hiddenOfferLightbox: true
      };
      this.user = {
        fullname: 'Гость',
        avatar: '../../../images/users/anonymous.png'
      };
    });

    $('.js-auth').on('click', handling.loginHandler);
    $('.offer-plates').on({
      'click': handling.offerActionHandler,
      'keypress': handling.commentingHandler
    });
    $('.lightboxes').on({
      'click': handling.offerActionHandler,
      'keypress': handling.commentingHandler
    });

    login.renderUser();
    offerCard.renderOffersCards();
  }, 'json');
})();

var handling = (function () {
  return {
    loginHandler: function(){
      login.authorize($('.js-login').val(), function () {
        offerCard.renderOffersCards();
      });
    },
    offerActionHandler: function (e) {
      var
        $target = $(e.target),
        button = $target.attr('data-button') || $target.parents('[data-button]').attr('data-button'),
        messageId = $target.parents('.author').attr('data-message-id'),
        offerId = $target.parents('[data-offer-id]').attr('data-offer-id');

      switch (button) {
        case 'like':
          offerCard.like(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          break;
        case 'like-lbx':
          offerCard.like(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'save':
          offerCard.save(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          break;
        case 'save-lbx':
          offerCard.save(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'viewComment':
          offerCard.viewComments(offerId);
          offerCard.renderOfferCard(offerId);
          break;
        case 'viewAnswer':
          offerCard.viewAnswers(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'openOfferLightbox':
          offerCard.openOfferLightbox(offerId);
          break;
        case 'closeOfferLightbox':
          offerCard.closeOfferLightbox(offerId);
          break;
        case 'removeComment':
          offerCard.removeComment(offerId, messageId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          break;
        case 'removeAnswer':
          offerCard.removeAnswer(offerId, messageId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'removeOffer':
          offerCard.removeOffer(offerId);
          offerCard.sendData();
          offerCard.closeOfferLightbox(offerId);
          offerCard.renderOffersCards();
          break;
      }
    },
    commentingHandler: function (e) {
      var
        $target = $(e.target),
        offerId = $target.parents('[data-offer-id]').attr('data-offer-id');

      if (((e.keyCode == 13 || e.which == 13) && !e.shiftKey) && $target.val()) {
        if ($target.hasClass('js-comment')) {
          offerCard.addComment(offerId, $target.val());
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
        }
        if ($target.hasClass('js-answer')) {
          offerCard.addAnswer(offerId, $target.val());
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
        }

        $target.val('');
        e.preventDefault();
      }
    }
  }
})();