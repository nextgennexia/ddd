(function ($) {
  $.login = function (params, callback) {
    var user = {
      params: $.extend(params),
      authorize: function () {
        $.post('/get-user', params.id, function (data) {
          $.each(preparedObj.offers, function () {
            this.user = data;
          });
          user.renderUser();
        }, 'json', 'text/plain');
      },
      renderUser: function () {
        params.loginNode.html(preparedObj.userTempl(preparedObj.offers[0].user));
        if (callback) {
          callback();
        }
      }
    };

    return {
      authorize: function () {
        user.authorize();
        user.renderUser();
      },
      renderUser: function () {
        user.renderUser();
      }
    }
  };
})(jQuery);
var preparedObj = [];

Array.prototype.last = function () {
  return this[this.length - 1];
};

(function () {
  preparedObj.offerCardTempl = Handlebars.compile($('#offer-card-templ').html());
  preparedObj.offerTempl = Handlebars.compile($('#offer-templ').html());
  preparedObj.userTempl = Handlebars.compile($('#user-plate-templ').html());

  $.get('/offers.json', function (data) {
    preparedObj.offers = data.slice();

    $.each(preparedObj.offers, function () {
      this.states = {
        hiddenComments: true,
        hiddenAnswers: true
      };
      this.user = {
        fullname: 'Гость',
        avatar: '../../../images/users/anonymous.png'
      };
    });
    $.handlers().loginHandler();
  }, 'json');
})();

(function ($) {
  $.handlers = function () {
    var handlers = {

      loginHandler: function () {
        $.login({
          id: $('.login .field-text').val(),
          loginNode: $('.login-wrap .author')
        }, function () {
          $('.login .button').on('click', handlers.loginHandler);
          $.offerCard().renderOffersCards();
          $('.js-comment').on('keypress', handlers.commentingHandler);
        }).authorize();
      },
      offerActionHandler: function (e) {
        var
          targetNode = $(e.target),
          button = targetNode.attr('data-button') || targetNode.parents('[data-button]').attr('data-button'),
          offerNode = $(this),
          offerId = offerNode.attr('data-id'),
          offerCard = $.offerCard({
            offerId: offerId,
            targetNode: targetNode,
            offerNode: offerNode,
            offerLightboxWrapNode: $('.lightbox-wrap')
          });

        switch (button) {
          case 'like':
            offerCard.like();
            break;
          case 'save':
            offerCard.save();
            break;
          case 'viewComment':
            offerCard.viewComments();
            break;
          case 'viewAnswer':
            offerCard.viewAnswers();
            break;
          case 'openOfferLightbox':
            offerCard.openOfferLightbox();
            break;
          case 'closeOfferLightbox':
            offerCard.closeOfferLightbox();
            break;
          case 'removeComment':
            offerCard.removeComment();
            break;
          case 'removeAnswer':
            offerCard.removeAnswer();
            break;
          case 'removeOffer':
            offerCard.removeOffer();
            break;
        }
      },
      commentingHandler: function (e) {
        var offerCard = $.offerCard({
          offerId: $(this).attr('data-id'),
          offerNode: $(this).parents('.js-offer-card-wrap'),
          targetNode: $(e.target),
          offerLightboxWrapNode: $('.lightbox-wrap')
        });

        if (((e.keyCode == 13 || e.which == 13) && !e.shiftKey) && this.value) {
          if ($(this).hasClass('js-comment')) {
            offerCard.addComment(this.value);
          }
          if ($(this).hasClass('js-answer')) {
            offerCard.addAnswer(this.value);
          }

          $(this).val('');
          e.preventDefault();
        }
      }
    }

    return {
      loginHandler: handlers.loginHandler,
      offerActionHandler: handlers.offerActionHandler,
      commentingHandler: handlers.commentingHandler
    }
  };
})(jQuery);
Handlebars.registerHelper('ifCond', function (v1, operator, v2, options) {

  switch (operator) {
    case '!=':
      return (v1 != v2) ? options.fn(this) : options.inverse(this);
    case '==':
      return (v1 == v2) ? options.fn(this) : options.inverse(this);
    case '===':
      return (v1 === v2) ? options.fn(this) : options.inverse(this);
    case '<':
      return (v1 < v2) ? options.fn(this) : options.inverse(this);
    case '<=':
      return (v1 <= v2) ? options.fn(this) : options.inverse(this);
    case '>':
      return (v1 > v2) ? options.fn(this) : options.inverse(this);
    case '>=':
      return (v1 >= v2) ? options.fn(this) : options.inverse(this);
    case '&&':
      return (v1 && v2) ? options.fn(this) : options.inverse(this);
    case '||':
      return (v1 || v2) ? options.fn(this) : options.inverse(this);
    default:
      return options.inverse(this);
  }
});

Handlebars.registerHelper('renderLatestMessages', function (context, countMessage, messageLength, options) {
  var
      ret = '',
      i = 0,
      comment,
      lastId = context.length - 1;

  for (i; i < countMessage; i++) {
    if (context[lastId]) {
      if (context[lastId].removed) {
        lastId--;
        i--;
        continue;
      }
      comment = context[lastId].comment;

      if (messageLength && context[lastId].comment.length > messageLength) {
        context[lastId].comment = context[lastId].comment.slice(0, messageLength) + '...';
      }

      ret = options.fn(context[lastId]) + ret;
      context[lastId].comment = comment;
      lastId--;
    }
  }

  return ret;
});
(function ($) {
  $.offerCard = function (params, callback) {
    var offer = {
      params: $.extend(params),
      like: function () {
        offer.countActions('likes');
      },
      save: function () {
        offer.countActions('saved');
      },
      viewMessages: function (subject) {
        preparedObj.offers[params.offerId].states[subject] = !preparedObj.offers[params.offerId].states[subject];
        params.offerNode.find('.comments').toggleClass('hidden');
        params.targetNode.toggleClass('active');
      },
      toogleOfferLightbox: function () {
        $('body').toggleClass('lock');
        params.offerLightboxWrapNode.toggleClass('hidden');
      },
      addMessage: function (subject, message) {
        var currentId;

        if (!preparedObj.offers[params.offerId][subject][0].count) {
          currentId = 0
        } else {
          currentId = preparedObj.offers[params.offerId][subject][0].fromUsers.last().id + 1;
        }

        obj = {
          id: currentId,
          userId: preparedObj.offers[params.offerId].user.id,
          avatar: preparedObj.offers[params.offerId].user.avatar,
          comment: message
        }

        preparedObj.offers[params.offerId][subject][0].count += 1;
        preparedObj.offers[params.offerId][subject][0].fromUsers.push(obj);
      },
      removeMessage: function (subject) {
        $.each(preparedObj.offers[params.offerId][subject][0].fromUsers, function () {
          if (this.id == params.targetNode.parents('.author').attr('data-id')) {
            preparedObj.offers[params.offerId][subject][0].count -= 1;
            this.removed = true;
            return false;
          }
        });
      },
      removeOffer: function () {
        preparedObj.offers[params.offerId].removed = true;
      },
      countActions: function (subject) {
        var hasAction = false;

        $.each(preparedObj.offers[params.offerId][subject][0].fromUsers, function (i) {
          if (this.userId == preparedObj.offers[params.offerId].user.id) {
            hasAction = true;
            preparedObj.offers[params.offerId][subject][0].count -= 1;
            preparedObj.offers[params.offerId][subject][0].fromUsers.splice(i, 1);
            return false;
          }
        });

        if (!hasAction) {
          preparedObj.offers[params.offerId][subject][0].count += 1;
          obj = {
            userId: preparedObj.offers[params.offerId].user.id,
            avatar: preparedObj.offers[params.offerId].user.avatar
          }
          preparedObj.offers[params.offerId][subject][0].fromUsers.push(obj);
        }
      },
      sendData: function () {
        $.ajax({
          method: 'POST',
          url: '/refresh',
          data: JSON.stringify(preparedObj.offers),
          dataType: 'json',
          success: function (data) {
            try {
              preparedObj.offers = data.slice();
            } catch (e) {
              sendData();
            }
          }
        });
      },
      renderOffersCards: function () {
        var
          columns = $('.column'),
          $templ,
          handlers = $.handlers(),
          offerIndex = 0,
          i;

       $.each(columns, function () {
          $(this).html('');
        });

        while (offerIndex < preparedObj.offers.length) {
          for (i = 0; i < columns.length; i++) {
            if (offerIndex >= preparedObj.offers.length) break;
            if (preparedObj.offers[offerIndex].removed) {
              offerIndex++;
              i--;
              continue;
            }
            $templ = $(preparedObj.offerCardTempl(preparedObj.offers[offerIndex]));
            $(columns[i]).append($templ);
            $templ.on('click', handlers.offerActionHandler);
            offerIndex++;
          }
        }
      },
      renderOfferCard: function () {
        var
          handlers = $.handlers(),
          $templ = $(preparedObj.offerCardTempl(preparedObj.offers[params.offerId]));

        params.offerNode.replaceWith($templ);
        $templ.on('click', handlers.offerActionHandler);
        $('.js-offer-card-wrap[data-id="' + params.offerId + '"] .js-comment').on('keypress', handlers.commentingHandler);
      },
      renderOfferLightbox: function () {
        var
          handlers = $.handlers(),
          $templ = $(preparedObj.offerTempl(preparedObj.offers[params.offerId]));

        params.offerLightboxWrapNode.html($templ);
        $templ.on('click', handlers.offerActionHandler);
        $('.js-answer').on('keypress', handlers.commentingHandler);
      }
    };

    return facadeOffer = {
      like: function () {
        offer.like();
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      save: function () {
        offer.save();
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      viewComments: function () {
        offer.viewMessages('hiddenComments');
      },
      viewAnswers: function () {
        offer.viewMessages('hiddenAnswers');
      },
      openOfferLightbox: function(){
        offer.toogleOfferLightbox();
        offer.renderOfferLightbox();
      },
      closeOfferLightbox: function () {
        offer.toogleOfferLightbox();
      },
      addComment: function (msg) {
        offer.addMessage('comments', msg);
        offer.sendData();
        offer.renderOfferCard();
      },
      addAnswer: function (msg) {
        offer.addMessage('answers', msg);
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      removeComment: function () {
        offer.removeMessage('comments');
        offer.sendData();
        offer.renderOfferCard();
      },
      removeAnswer: function () {
        offer.removeMessage('answers');
        offer.sendData();
        offer.renderOfferCard();
        offer.renderOfferLightbox();
      },
      removeOffer: function () {
        offer.removeOffer();
        offer.sendData();
        offer.toogleOfferLightbox();
        offer.renderOffersCards();
      },
      renderOffersCards: function () {
        offer.renderOffersCards();
      }
    };
  }
})(jQuery);