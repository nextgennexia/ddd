var login = (function () {
  return {
    authorize: function (id, callback) {
      $.post('/get-user', id, function (data) {
        $.each(preparedObj.offers, function () {
          this.user = data;
        });
        login.renderUser();
        if (callback) {
          callback();
        }
      }, 'json', 'text/plain');
    },
    renderUser: function () {
      $('.login-wrap .author').html(preparedObj.userTempl(preparedObj.offers[0].user));
    }
  }
})();
var preparedObj = [];

Array.prototype.last = function () {
  return this[this.length - 1];
};

(function () {
  preparedObj.offerCardTempl = Handlebars.compile($('#offer-card-templ').html());
  preparedObj.offerTempl = Handlebars.compile($('#offer-templ').html());
  preparedObj.userTempl = Handlebars.compile($('#user-plate-templ').html());

  $.get('/offers.json', function (data) {
    preparedObj.offers = data.slice();

    $.each(preparedObj.offers, function () {
      this.states = {
        hiddenComments: true,
        hiddenAnswers: true,
        hiddenOfferLightbox: true
      };
      this.user = {
        fullname: 'Гость',
        avatar: '../../../images/users/anonymous.png'
      };
    });

    $('.js-auth').on('click', handling.loginHandler);
    $('.lightboxes').on({
      'click': handling.offerActionHandler,
      'keypress': handling.commentingHandler
    });
    login.renderUser();
    offerCard.renderOffersCards();
  }, 'json');
})();

var handling = (function () {
  return {
    loginHandler: function(){
      login.authorize($('.js-login').val(), function () {
        offerCard.renderOffersCards();
      });
    },
    offerActionHandler: function (e) {
      var
        $offer = $(this),
        $target = $(e.target),
        button = $target.attr('data-button') || $target.parents('[data-button]').attr('data-button'),
        messageId = $target.parents('.author').attr('data-id'),
        offerId = $offer.attr('data-id') || $offer.children().first().attr('data-id');

      switch (button) {
        case 'like':
          offerCard.like(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          break;
        case 'like-lbx':
          offerCard.like(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'save':
          offerCard.save(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          break;
        case 'save-lbx':
          offerCard.save(offerId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'viewComment':
          offerCard.viewComments(offerId);
          offerCard.renderOfferCard(offerId);
          break;
        case 'viewAnswer':
          offerCard.viewAnswers(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'openOfferLightbox':
          offerCard.openOfferLightbox(offerId);
          break;
        case 'closeOfferLightbox':
          offerCard.closeOfferLightbox(offerId);
          break;
        case 'removeComment':
          offerCard.removeComment(offerId, messageId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          break;
        case 'removeAnswer':
          offerCard.removeAnswer(offerId, messageId);
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
          break;
        case 'removeOffer':
          offerCard.removeOffer(offerId);
          offerCard.sendData();
          offerCard.closeOfferLightbox(offerId);
          offerCard.renderOffersCards();
          break;
      }
    },
    commentingHandler: function (e) {
      var
        $target = $(e.target),
        offerId = $target.attr('data-id');

      if (((e.keyCode == 13 || e.which == 13) && !e.shiftKey) && $target.val()) {
        if ($target.hasClass('js-comment')) {
          offerCard.addComment(offerId, $target.val());
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
        }
        if ($target.hasClass('js-answer')) {
          offerCard.addAnswer(offerId, $target.val());
          offerCard.sendData();
          offerCard.renderOfferCard(offerId);
          offerCard.renderOfferLightbox(offerId);
        }

        $target.val('');
        e.preventDefault();
      }
    }
  }
})();
Handlebars.registerHelper('ifCond', function (v1, operator, v2, options) {

  switch (operator) {
    case '!=':
      return (v1 != v2) ? options.fn(this) : options.inverse(this);
    case '==':
      return (v1 == v2) ? options.fn(this) : options.inverse(this);
    case '===':
      return (v1 === v2) ? options.fn(this) : options.inverse(this);
    case '<':
      return (v1 < v2) ? options.fn(this) : options.inverse(this);
    case '<=':
      return (v1 <= v2) ? options.fn(this) : options.inverse(this);
    case '>':
      return (v1 > v2) ? options.fn(this) : options.inverse(this);
    case '>=':
      return (v1 >= v2) ? options.fn(this) : options.inverse(this);
    case '&&':
      return (v1 && v2) ? options.fn(this) : options.inverse(this);
    case '||':
      return (v1 || v2) ? options.fn(this) : options.inverse(this);
    default:
      return options.inverse(this);
  }
});

Handlebars.registerHelper('renderLatestMessages', function (context, countItem, options) {
  return options.fn($.grep(context, function (item, index) {
    return !item.removed;
  }).slice(-countItem));
});

Handlebars.registerHelper('trancate', function (context, messageLength, options) {
  return (context.length > messageLength) ? options.fn(context.slice(0, messageLength) + '...') : options.fn(context);
});


var offerCard = (function () {

  function addMessage(subject, offerId, message) {
    preparedObj.offers[offerId][subject].push({
      id: preparedObj.offers[offerId][subject].length,
      userId: preparedObj.offers[offerId].user.id,
      avatar: preparedObj.offers[offerId].user.avatar,
      comment: message
    });
  };

  function countActions(subject, offerId) {
    var hasAction = false;

    $.each(preparedObj.offers[offerId][subject], function (i) {
      if (this.userId == preparedObj.offers[offerId].user.id) {
        hasAction = true;
        preparedObj.offers[offerId][subject].splice(i, 1);
        return false;
      }
    });

    if (!hasAction) {
      preparedObj.offers[offerId][subject].push({
        userId: preparedObj.offers[offerId].user.id,
        avatar: preparedObj.offers[offerId].user.avatar
      });
    }
  };

  function toogleView(subject, offerId, switcher) {
    if (switcher === true) {
      preparedObj.offers[offerId].states[subject] = false;
    } else if (switcher === false) {
      preparedObj.offers[offerId].states[subject] = true;
    } else {
      preparedObj.offers[offerId].states[subject] = !preparedObj.offers[offerId].states[subject];
    }
  }

  return {
    like: function (offerId) {
      countActions('likes', offerId);
    },
    save: function (offerId) {
      countActions('saved', offerId);
    },
    viewComments: function (offerId) {
      toogleView('hiddenComments', offerId);
    },
    viewAnswers: function (offerId) {
      toogleView('hiddenAnswers', offerId);
    },
    addComment: function (offerId, message) {
      addMessage('comments', offerId, message);
    },
    addAnswer: function (offerId, message) {
      addMessage('answers', offerId, message);
    },
    removeComment: function (offerId, messageId) {
      preparedObj.offers[offerId].comments[messageId].removed = true;
    },
    removeAnswer: function (offerId, messageId) {
      preparedObj.offers[offerId].answers[messageId].removed = true;
    },
    openOfferLightbox: function (offerId) {
      toogleView('hiddenOfferLightbox', offerId, true);
      $('body').addClass('lock');
      offerCard.renderOfferLightbox(offerId);
    },
    closeOfferLightbox: function (offerId) {
      toogleView('hiddenOfferLightbox', offerId, false);
      $('body').removeClass('lock');
      offerCard.renderOfferLightbox(offerId);
    },
    removeOffer: function (offerId) {
      preparedObj.offers[offerId].removed = true;
    },
    sendData: function () {
      $.ajax({
        method: 'POST',
        url: '/refresh',
        data: JSON.stringify(preparedObj.offers),
        dataType: 'json',
        success: function (data) {
          try {
            preparedObj.offers = data.slice();
          } catch (e) {
            sendData();
          }
        }
      });
    },
    renderOffersCards: function () {
      var
        columns = $('.column'),
        offerIndex = 0;

      $.each(columns, function () {
        $(this).html('');
      });

      $.each(preparedObj.offers, function (index, item) {
        if (!item.removed) {
          if (offerIndex > 3) {
            offerIndex = 0;
          }
          $(columns[offerIndex]).append(preparedObj.offerCardTempl(item));
          offerIndex++;
        }
      });

      $('.js-offer-card-wrap').on({
        'click': handling.offerActionHandler,
        'keypress': handling.commentingHandler
      });
    },
    renderOfferCard: function (offerId) {
      $('.js-offer-card-wrap[data-id="'+ offerId + '"]').html(preparedObj.offerCardTempl(preparedObj.offers[offerId]));
    },
    renderOfferLightbox: function (offerId) {
      $('.lightboxes').html(preparedObj.offerTempl(preparedObj.offers[offerId]));
    }
  };
})();