var
  offers = [],
  user = {
    fullname: 'Гость',
    avatar: '../../../images/users/anonymous.png'
  };

$('.login .button').on('click', function () {
  getLoggedUser($('.login .field-text').val());
})

getOffers();

function getOffers() {
  $.ajax({
    method: 'GET',
    url: '/offers.json',
    dataType: 'json',
    cache: false,
    success: function(data) {
      $.each(data,
        function() {
          offers = data.slice();
        });
      renderShortOffers();
    }
  });
}

function offerRefresh() {
  $.ajax({
    method: 'POST',
    url: '/refresh',
    data: JSON.stringify(offers),
    dataType: 'json',
    success: function(data) {
      try {
        offers = data.slice();
      } catch (e) {
        offerRefresh();
      }
    }
  });
}

function getLoggedUser(id) {
  $.ajax({
    method: 'POST',
    url: '/get-user',
    data: id,
    dataType: 'json',
    success: function (data) {
      user = data;
      renderTemplate('#user-plate-templ', '.login-wrap .author', user);
      renderShortOffers();
    }
  });
};
Array.prototype.last = function () {
  return this[this.length - 1];
}

var removedObjects = [{
  offers: [],
  comments: [],
  answers: []
}];

function offerActionHandler(e) {
  var
    $target = $(e.target),
    button = $target.attr('data-button') || $target.parents('[data-button]').attr('data-button'),
    offer = new Offer(this);

  switch (button) {
    case 'like':
      offer.like();
      break;
    case 'save':
      offer.save();
      break;
    case 'viewComment':
      offer.viewComment($target);
      break;
    case 'openOfferLightbox':
      offer.openOfferLightbox();
      break;
    case 'closeOfferLightbox':
      offer.closeOfferLightbox();
      break;
    case 'removeComment':
      offer.removeComment($target.parents('.author'));
      break;
    case 'removeAnswer':
      offer.removeAnswer($target.parents('.author'));
      break;
    case 'removeOffer':
      offer.removeOffer();
      break;
  }
}

function commentingHandler(e) {
  if (((e.keyCode == 13 || e.which == 13) && !e.shiftKey) && this.value) {
    if ($(this).hasClass('js-comment')) {
      new Offer($(this).parents('.offer-plate')).addComment(this.value);
    }
    if ($(this).hasClass('js-answer')) {
      new Offer($(this).parents('.lightbox.offer')).addAnswer(this.value);
    }

    $(this).val('');
    e.preventDefault();
  }
}

function Offer(self) {
  var
    $offer = $(self),
    offerId = $offer.attr('data-id'),
    offerIndex;

  $.each(offers, function (i) {
    if (this.id == offerId) {
      offerIndex = i;
      return false;
    }
  });

  this.like = function () {
    countActions('likes');
    socialActionRefresh();
  }

  this.save = function () {
    countActions('saved');
    socialActionRefresh();
  }

  this.viewComment = function ($target) {
    $offer.find('.comments').toggleClass('hidden');
    $target.toggleClass('active');
  }

  this.openOfferLightbox = function () {
    $('body').addClass('lock');
    $('.lightbox-wrap').removeClass('hidden');
    renderOffer(offerIndex);
  }

  this.closeOfferLightbox = function () {
    $('body').removeClass('lock');
    $('.lightbox-wrap').addClass('hidden');
  }

  this.addComment = function (comment) {
    addMessage('comments', comment);
    offerRefresh();
    renderTemplate('#social-info-templ', '.offer-plate[data-id="' + offerId + '"] .social-info', offers[offerIndex]);
    renderTemplate('#latest-comments-templ', '.offer-plate[data-id="' + offerId + '"] .latest-comments',
        offers[offerIndex]);
  }

  this.addAnswer = function (answer) {
    addMessage('answers', answer);
    offerRefresh();
    renderTemplate('#social-info-templ', '.offer-plate[data-id="' + offerId + '"] .social-info', offers[offerIndex]);
    renderTemplate('#latest-answers-templ', '.lightbox.offer[data-id="' + offerId + '"] .latest-comments', offers[offerIndex]);
  }

  this.removeComment = function ($commentElem) {
    removeMessage('comments', $commentElem);
    renderTemplate('#social-info-templ', '.offer-plate[data-id="' + offerId + '"] .social-info', offers[offerIndex]);
    renderTemplate('#latest-comments-templ', '.offer-plate[data-id="' + offerId + '"] .latest-comments',
        offers[offerIndex]);
  }

  this.removeAnswer = function ($answerElem) {
    removeMessage('answers', $answerElem);
    renderTemplate('#social-info-templ', '.offer-plate[data-id="' + offerId + '"] .social-info', offers[offerIndex]);
    renderTemplate('#latest-answers-templ', '.lightbox.offer[data-id="' + offerId + '"] .latest-comments', offers[offerIndex]);
  }

  this.removeOffer = function () {
    this.closeOfferLightbox();
    $('.offer-plate[data-id="' + offerId + '"]').remove();
    removedObjects[0].offers.push(offers[offerIndex]);
    offers.splice(offerIndex, 1);
    offerRefresh();
  }

  function countActions(subject) {
    var hasAction = false;

    $.each(offers[offerIndex][subject][0].fromUsers, function (i) {
      if (this.userId == user.id) {
        hasAction = true;
        offers[offerIndex][subject][0].count -= 1;
        offers[offerIndex][subject][0].fromUsers.splice(i, 1);
        return false;
      }
    });

    if (!hasAction) {
      offers[offerIndex][subject][0].count += 1;
      obj = {
        userId: user.id,
        avatar: user.avatar
      }
      offers[offerIndex][subject][0].fromUsers.push(obj);
    }
  }

  function addMessage(subject, message) {
    var currentId;

    if (!offers[offerIndex][subject][0].count) {
      currentId = 0
    } else {
      currentId = offers[offerIndex][subject][0].fromUsers.last().id + 1;
    }

    obj = {
      id: currentId,
      userId: user.id,
      avatar: user.avatar,
      comment: message
    }

    offers[offerIndex][subject][0].count += 1;
    offers[offerIndex][subject][0].fromUsers.push(obj);
  }

  function removeMessage(subject, $messageElem) {
    var
        comments = offers[offerIndex][subject][0].fromUsers,
        commentId = $messageElem.attr('data-id');

    $.each(comments, function (i) {
      if (this.id == commentId) {
        removedObjects[0][subject].push(this);
        offers[offerIndex][subject][0].count -= 1;
        comments.splice(i, 1);
        return false;
      }
    })

    $messageElem.remove();
    offerRefresh();
  }

  function socialActionRefresh() {
    offerRefresh();
    renderTemplate('#social-buttons-templ', '.offer-plate[data-id="' + offerId + '"] .social-actions', offers[offerIndex]);
    renderTemplate('#social-info-templ', '.offer-plate[data-id="' + offerId + '"] .social-info', offers[offerIndex]);
    renderTemplate('#lightbox-social-info-templ', '.lightbox.offer[data-id="' + offerId + '"] .lightbox-footer', offers[offerIndex]);
    renderTemplate('#lightbox-social-buttons-templ', '.lightbox.offer[data-id="' + offerId + '"] .social-actions', offers[offerIndex]);
  }
}
Handlebars.registerHelper('renderLatestMessages', function (context, subject, options) {
  var
    countItem,
    textLength;

  switch (subject) {
    case 'comments':
      countItem = 5;
      textLength = 40;
      break;
    case 'answers':
      countItem = 3;
      break;
  }

  return latestMessagesHelper(context, options, countItem, textLength);
});

Handlebars.registerHelper('renderCloseElement', function (context, options) {
  if (context == user.id) {
    return options.fn(context)
  }
});

Handlebars.registerHelper('like', function (context, options) {
  return addClassHelper(context, options, 'liked', 'active');
});

Handlebars.registerHelper('save', function (context, options) {
  return addClassHelper(context, options, 'saved', 'active');
});

Handlebars.registerHelper('renderButtonRemoveOffer', function (context, options) {
  return addClassHelper(context, options, 'hidden', 'hidden', true);
});

Handlebars.registerHelper('renderCountActions', function (context, options) {
  if (context) {
    return options.fn(context);
  };
});

function latestMessagesHelper(context, options, countMessage, messageLength) {
  var
    ret = '',
    i,
    comment;

  for (i = context.length - countMessage; i < context.length; i++) {
    if (context[i]) {
      comment = context[i].comment;

      if (messageLength && context[i].comment.length > messageLength) {
        context[i].comment = context[i].comment.slice(0, messageLength) + '...';
      };

      ret += options.fn(context[i]);
      context[i].comment = comment;
    }
  };

  return ret;
};

function addClassHelper(context, options, elem, className, inverse) {
  var ret;

  $.each(context, function () {
    if ((inverse && this.userId != user.id) || (!inverse && this.userId == user.id)) {
      context[elem] = className;
      return false;
    }
  });

  ret = options.fn(context)
  delete context[elem];

  return ret;
};
function renderOffer(offerIndex) {
  var template = Handlebars.compile($('#offer-templ').html());

  $('.lightbox-wrap').html(template(offers[offerIndex]));
  renderInputMessage('answer');
  $('.lightbox.offer').on('click', offerActionHandler);
  $('.js-answer').on('keypress', commentingHandler);
}

function renderShortOffers() {
  var
    template,
    columns = $('.column'),
    offerIndex = 0,
    offerId;

  template = Handlebars.compile($('#offer-plate-templ').html());

  $.each(columns, function () {
    $(this).html('');
  });

  while (offerIndex < offers.length) {
    $.each(columns, function () {
      var
        $currentImg,
        $imgContainer;

      $(this).append(template(offers[offerIndex]));
      $currentImg = $(this).find('.offer-img').last();
      $imgContainer = $currentImg.parent();
      offerId = offers[offerIndex].id;

      if ($currentImg.width() > 0 && $currentImg.width() < $imgContainer.width()) {
        $currentImg.addClass('small');
      }

      offerIndex += 1;

      if (offerIndex >= offers.length) return false;
    });
  }

  renderInputMessage('comment');
  $('.offer-plate').on('click', offerActionHandler);
  $('.js-comment').on('keypress', commentingHandler);
}

function renderInputMessage(subject) {
  var
    template,
    sourceSelector,
    containerSelector;

  switch (subject) {
    case 'comment':
      sourceSelector = '#add-comment-templ';
      containerSelector = '.add-comment';
      break;
    case 'answer':
      sourceSelector = '#add-answer-templ';
      containerSelector = '.add-answer';
      break;
    default:
      return false;
  }

  template = Handlebars.compile($(sourceSelector).html());
  $(containerSelector).append(template(user));
}

function renderTemplate(templateSelector, containerSelector, obj) {
  var template;

  template = Handlebars.compile($(templateSelector).html());
  $(containerSelector).html(template(obj));
};